<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm Grid: Industrial ASCII Club - ULTIMATE CONSOLIDATED V9</title>
    <style>
        :root {
            --bg-color: #050505;
            --accent-color: #00ff00;
            --excellent: #00ffff;
            --great: #adff2f;
            --good: #ffd700;
            --miss: #ff4500;
            --playlist-color: #ff00ff;
            --powerup-color: #ffff00;
            --panel-bg: rgba(10, 10, 10, 0.98);
            --border-color: #333;
            --terminal-font: 'Courier New', Courier, monospace;
        }

        body {
            background-color: var(--bg-color);
            color: #eee;
            font-family: var(--terminal-font);
            display: flex;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            text-transform: uppercase;
        }

        #main-view {
            flex-grow: 1; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            position: relative;
            padding: 20px;
            box-sizing: border-box;
            min-height: 100vh;
        }

        /* PANELES LATERALES */
        .side-panel {
            position: fixed; top: 0; width: 300px; max-width: 90vw; height: 100vh;
            background: var(--panel-bg); border: 1px solid var(--border-color);
            padding: 20px; display: none; flex-direction: column;
            gap: 8px; overflow-y: auto; z-index: 2000; backdrop-filter: blur(8px);
            box-sizing: border-box;
        }
        #debug-panel { right: 0; border-left: 1px solid var(--accent-color); }
        #appearance-panel { left: 0; border-right: 1px solid var(--excellent); }
        #playlist-panel { 
            left: 50%; 
            transform: translateX(-50%); 
            border: 1px solid var(--playlist-color); 
            height: auto; 
            max-height: 80vh;
            top: 60px; 
            border-radius: 5px; 
        }
        #powerup-panel { 
            left: 50%; 
            transform: translateX(-50%); 
            border: 1px solid var(--powerup-color); 
            height: auto; 
            max-height: 80vh;
            top: 60px; 
            border-radius: 5px; 
        }

        .debug-group { 
            display: flex; flex-direction: column; gap: 4px; 
            background: #000; padding: 8px; border: 1px solid #222;
        }
        .debug-group label { font-size: 9px; letter-spacing: 1px; color: #888; display: flex; justify-content: space-between; align-items: center; }

        h3 { font-size: 11px; margin: 5px 0; letter-spacing: 2px; border-bottom: 1px solid #333; padding-bottom: 5px; color: #fff; }

        /* UI */
        #ui-layer { 
            text-align: center; 
            margin-bottom: 10px; 
            min-width: 450px; 
            position: relative; 
            z-index: 50; 
            margin-top: 20px;
        }
        #combo-counter { 
            font-size: 42px; 
            color: var(--accent-color); 
            font-weight: 900; 
            margin: 0; 
            text-shadow: 0 0 10px var(--accent-color); 
            line-height: 1;
        }
        #accuracy-feedback { 
            font-size: 12px; 
            letter-spacing: 4px; 
            height: 20px; 
            margin-top: 5px; 
            font-weight: bold; 
            min-height: 20px;
        }
        
        #status-hud { 
            font-size: 11px; color: var(--powerup-color); background: rgba(0, 0, 0, 0.9); 
            padding: 10px; border: 1px solid var(--powerup-color); margin-top: 10px; 
            display: none; flex-direction: column; align-items: center; gap: 5px;
        }
        .progress-bar-container { width: 100%; height: 4px; background: #333; position: relative; }
        #progress-fill { height: 100%; background: var(--powerup-color); width: 100%; transition: width 0.1s linear; }

        /* JUEGO */
        #bpm-display { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            font-size: 20px; 
            color: var(--playlist-color); 
            border: 1px solid var(--playlist-color); 
            padding: 5px 12px; 
            background: rgba(0,0,0,0.9); 
            z-index: 100; 
            min-width: 100px;
            text-align: center;
        }
        #volume-control { 
            position: fixed; 
            top: 70px; 
            left: 20px; 
            display: flex; 
            flex-direction: row; 
            align-items: center;
            gap: 8px; 
            background: rgba(0,0,0,0.9); 
            padding: 6px 10px; 
            border: 1px solid #333; 
            z-index: 100; 
            min-width: auto;
            max-width: 180px;
        }
        #volume-control label {
            font-size: 8px;
            white-space: nowrap;
            margin: 0;
        }
        #volume-control input[type="range"] {
            width: 100px;
            height: 4px;
            margin: 0;
            -webkit-appearance: none;
            appearance: none;
            background: #333;
            outline: none;
        }
        #volume-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: var(--accent-color);
            cursor: pointer;
            border-radius: 50%;
        }
        #volume-control input[type="range"]::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: var(--accent-color);
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }

        #game-container { width: 450px; border: 1px solid #333; background: #000; position: relative; transition: transform 0.05s ease-out; }
        #zona-juego { display: block; width: 450px; height: 350px; }
        #zona-beat { width: 450px; height: 80px; background: #0a0a0a; border-top: 2px solid #222; position: relative; overflow: hidden; }
        #beat-target { position: absolute; left: 30px; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; border: 2px solid #444; }
        .note { position: absolute; top: 50%; transform: translateY(-50%); width: 25px; height: 25px; background: white; display: flex; align-items: center; justify-content: center; color: #000; font-weight: bold; }
        .inverted { filter: invert(1) hue-rotate(180deg); }

        /* BOTONES Y INPUTS */
        .btn { padding: 8px; font-weight: bold; cursor: pointer; border: 1px solid #444; background: #111; color: #eee; font-family: var(--terminal-font); font-size: 10px; }
        .btn:hover { background: #222; border-color: #888; }
        .menu-toggle { 
            position: fixed; 
            top: 20px; 
            background: rgba(0,0,0,0.9); 
            border: 1px solid #333; 
            color: #777; 
            z-index: 1500; 
            white-space: nowrap;
        }
        input[type="range"], select { background: #000; color: #fff; border: 1px solid #333; }
        
        /* Menu button positioning to avoid overlaps */
        #open-appearance { left: 20px; }
        #open-playlist { left: 180px; }
        #open-powerups { right: 180px; }
        #open-debug { right: 20px; }

        /* OVERLAY INICIAL */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.96); z-index: 3000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px;
            backdrop-filter: blur(10px); padding: 20px;
        }
        #pre-game-pu-list {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 620px;
            background: #111; padding: 20px; border: 1px solid #444;
        }
    </style>
</head>
<body>

    <div id="bpm-display">BPM: 120</div>

    <div id="volume-control">
        <label style="color:var(--accent-color)">VOL</label>
        <input type="range" id="input-volume" min="-60" max="0" value="-10">
    </div>

    <button id="open-appearance" class="btn menu-toggle">[ DISEÃ‘O_ASCII ]</button>
    <button id="open-playlist" class="btn menu-toggle">[ PLAYLIST_PRO ]</button>
    <button id="open-powerups" class="btn menu-toggle" style="border-color: var(--powerup-color);">[ POWER_UPS ]</button>
    <button id="open-debug" class="btn menu-toggle">[ SISTEMA_CORE ]</button>

    <div id="appearance-panel" class="side-panel">
        <button id="close-appearance" class="btn">_CERRAR_</button>
        <h3 style="color:var(--excellent)">VISUAL_CONFIG</h3>
        <div class="debug-group"><label>GRID_SIZE</label><input type="range" id="input-grid" min="16" max="64" step="2" value="32"></div>
        <div class="debug-group"><label>USER_AVATAR</label><select id="user-avatar"><option value="(âŒâ– _â– )">COOL</option><option value="(^o^)">HYPE</option><option value="(â—•â€¿â—•)">KAWAII</option><option value="d(-_-)b">DJ_SET</option></select></div>
        <div class="debug-group"><label>RHYTHM_HINTS</label><input type="checkbox" id="check-hints" checked></div>
        <div class="debug-group"><label>PLAYER_GLOW</label><input type="checkbox" id="check-player-glow" checked></div>
        
        <h3 style="color:var(--good)">CLUB_DECOR (OBJECTS)</h3>
        <div class="debug-group"><label>DJ_BOOTH</label><input type="checkbox" id="check-dj" checked></div>
        <div class="debug-group"><label>BARTENDER</label><input type="checkbox" id="check-barman" checked></div>
        <div class="debug-group"><label>VIP_SOFAS</label><input type="checkbox" id="check-sofas" checked></div>
        <div class="debug-group"><label>TABLES</label><input type="checkbox" id="check-tables" checked></div>
        <div class="debug-group"><label>SCREENS</label><input type="checkbox" id="check-screens" checked></div>
        <div class="debug-group"><label>LASERS</label><input type="checkbox" id="check-lasers" checked></div>
        <div class="debug-group"><label>SIDE_BARS</label><input type="checkbox" id="check-sidebars" checked></div>
        <div class="debug-group"><label>SMOKING_ZONE</label><input type="checkbox" id="check-smoking" checked></div>
        <div class="debug-group"><label>RESTROOMS</label><input type="checkbox" id="check-wc" checked></div>
    </div>

    <div id="playlist-panel" class="side-panel">
        <button id="close-playlist" class="btn">_CERRAR_</button>
        <h3 style="color:var(--playlist-color)">AUDIO_SYNC_PRO</h3>
        <div class="debug-group"><label>AUTO_BPM</label><input type="checkbox" id="playlist-auto-bpm" checked></div>
        <div class="debug-group"><label>CHANGE_FREQ</label><input type="range" id="input-pl-freq" min="4" max="64" step="4" value="16"></div>
        <div class="debug-group"><label>KICK_TYPE</label><select id="input-kick-type"><option value="deep">DEEP_SUB</option><option value="tight">TIGHT_POP</option><option value="electro">ELECTRO</option></select></div>
        <div class="debug-group"><label>SNARE_TYPE</label><select id="input-snare-type"><option value="white">WHITE_NOISE</option><option value="brown">BROWN_HEAVY</option><option value="pink">PINK_SHARP</option></select></div>
        <div class="debug-group"><label>SNARE_ENABLED</label><input type="checkbox" id="check-snare-master" checked></div>
    </div>

    <div id="powerup-panel" class="side-panel">
        <button id="close-powerup" class="btn">_CERRAR_</button>
        <h3 style="color:var(--powerup-color)">POWER_UP_CONFIG</h3>
        <div id="pu-controls-container"></div>
    </div>

    <div id="debug-panel" class="side-panel">
        <button id="close-debug" class="btn">_CERRAR_</button>
        <h3 style="color:var(--accent-color)">SISTEMA_V3_CORE</h3>
        <div class="debug-group"><label>NPC_COUNT</label><input type="range" id="input-npc" min="1" max="60" value="15"></div>
        <div class="debug-group"><label>FOLLOW_RAD</label><input type="range" id="input-follow" min="3" max="30" value="9"></div>
        <div class="debug-group"><label>SYNC_TOLERANCE</label><input type="range" id="input-tol" min="50" max="300" value="100"></div>
        <div class="debug-group"><label>NOTE_SPEED</label><input type="range" id="input-note-speed" min="600" max="1500" step="50" value="900"></div>
        <div class="debug-group"><label>TIMING_WINDOW</label><input type="range" id="input-note-window" min="0.5" max="0.95" step="0.05" value="0.75"></div>
        <div class="debug-group"><label>MANUAL_BPM</label><input type="range" id="input-bpm" min="60" max="250" value="120"></div>
        <div class="debug-group"><label>COLLISION_SYSTEM</label><input type="checkbox" id="check-collision" checked></div>
        <button class="btn" style="border-color:#500; color:#f55; margin-top:10px;" onclick="reiniciarEscena()">_FORCE_RESET_SYSTEM</button>
    </div>

    <div id="main-view">
        <div id="start-overlay">
            <h1 style="color:var(--accent-color); letter-spacing: 5px;">RHYTHM_GRID_ULTIMATE</h1>
            <div id="objective-box" style="font-size: 10px; color: #888; text-align: center; max-width: 500px; border: 1px solid #333; padding: 10px;">
                MANTÃ‰N EL RITMO PARA LLEVAR A LOS NPC AL CORRAL AZUL. <br>
                CONFIGURA LOS EFECTOS DE POWER-UPS ANTES DE EMPEZAR.
            </div>
            <div id="pre-game-pu-list"></div>
            <div style="display:flex; gap:10px;">
                <button id="btn-random-pu" class="btn" style="border-color:var(--powerup-color)">RANDOMIZE_PU</button>
                <button id="start-btn" class="btn" style="color:var(--accent-color); font-size: 16px; border-color: var(--accent-color); padding: 15px 40px;">INITIALIZE_SESSION</button>
            </div>
        </div>

        <div id="ui-layer">
            <div id="combo-counter">000</div>
            <div id="accuracy-feedback">SYSTEM_READY</div>
            <div id="status-hud">
                <div id="status-label">EFFECT: NONE</div>
                <div class="progress-bar-container"><div id="progress-fill"></div></div>
            </div>
        </div>
        
        <div id="game-container">
            <canvas id="zona-juego" width="450" height="350"></canvas>
            <div id="zona-beat"><div id="beat-target"></div></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        // --- DATA & CONSTANTS ---
        const EFFECTS_LIST = {
            invert_controls: "CONTROLES INVERTIDOS",
            pause_beat: "SKIP_BEAT (8/8)",
            double_tempo: "DOUBLE_STEP (X2)",
            shake_screen: "MAREO (TEMBLOR)",
            tilt_screen: "MAREO (TILT)",
            invert_colors: "EPILEPSIA (FLASH)",
            off_beat: "OFF-BEAT CHALLENGE"
        };

        const PU_TYPES = {
            'DRINK':  { char: 'ðŸ¹', def: 'invert_controls', color: '#ff4444', desc: "Invierte flechas." },
            'CIGS':   { char: 'ðŸš¬', def: 'pause_beat', color: '#aaaaaa', desc: "Beat 8 vacÃ­o." },
            'PILL':   { char: 'ðŸ’Š', def: 'double_tempo', color: '#00ffff', desc: "Salto doble." },
            'WEED':   { char: 'ðŸŒ¿', def: 'tilt_screen', color: '#00ff00', desc: "Pantalla torcida." },
            'SHADES': { char: 'ðŸ•¶ï¸', def: 'invert_colors', color: '#ffffff', desc: "Efecto flash." },
            'MUSH':   { char: 'ðŸ„', def: 'off_beat', color: '#ff00ff', desc: "Doble nota." },
            'WATER':  { char: 'ðŸ’§', def: 'shake_screen', color: '#3333ff', desc: "Terremoto visual." }
        };

        // --- STATE ---
        let canvas, ctx, kick, snare;
        let config = { grid: 20, bpm: 120, tolerance: 100, collision: true, npcCount: 25, followRadius: 9, kickType: 'deep', showHints: true, snareEnabled: true, noteSpeed: 900, noteWindow: 0.75 };
        let appearance = { dj: true, barman: true, sofas: true, tables: true, screens: true, lasers: true, sidebars: true, smoking: true, wc: true, avatar: '(âŒâ– _â– )', playerGlow: true };
        let currentStatus = { type: null, label: 'NONE', beats: 0, maxBeats: 0 };
        let player = { x: 5, y: 5 }, npcs = [], obstacles = [], activeNotes = [], activePowerUpsOnMap = [], puConfig = {};
        let blueZone = { x: 14, y: 13, w: 8, h: 8 };
        let combo = 0, isStarted = false, beatCounter = 0, canMove = false, djStep = 0;

        // --- INITIALIZATION ---
        window.onload = () => {
            canvas = document.getElementById('zona-juego');
            ctx = canvas.getContext('2d');
            Object.keys(PU_TYPES).forEach(id => {
                puConfig[id] = { effect: PU_TYPES[id].def, rate: 15, dur: 16, last: Date.now(), enabled: true };
            });
            renderPreGameMenu();
            initPowerUpMenu();
            generarLayout();
            reiniciarEscena();
            requestAnimationFrame(draw);
        };

        // --- AUDIO ENGINE ---
        function updateKickParams() {
            if (config.kickType === 'deep') kick.set({ pitchDecay: 0.08, octaves: 5 });
            else if (config.kickType === 'tight') kick.set({ pitchDecay: 0.02, octaves: 2 });
            else kick.set({ pitchDecay: 0.1, octaves: 10 });
        }

        const loop = new Tone.Loop((time) => {
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'loop:entry',message:'Loop triggered',data:{beatCounter,isStarted,canMove,activeNotesCount:activeNotes.length,combo,doubleTempo:currentStatus.type==='double_tempo'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B,E'})}).catch(()=>{});
            // #endregion
            const isPause = (currentStatus.type === 'pause_beat' && (beatCounter+1)%8 === 0);
            if (!isPause) {
                kick.triggerAttackRelease("C1", "8n", time);
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'loop:kick',message:'Kick triggered',data:{time:time*1000},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
                // #endregion
                if (currentStatus.type === 'off_beat') {
                    Tone.Draw.schedule(() => crearNota(true), time + Tone.Time("8n").toSeconds());
                }
            }
            if (config.snareEnabled) snare.triggerAttackRelease("16n", time + Tone.Time("8n").toSeconds());

            Tone.Draw.schedule(() => {
                beatCounter++;
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'loop:schedule',message:'Beat scheduled',data:{beatCounter,canMoveBefore:canMove},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                // #endregion
                updateHUD();
                if (isStarted) spawnPowerUps();
                if (beatCounter % 16 === 0 && document.getElementById('playlist-auto-bpm').checked) autoAdjustBpm();
                djStep = (djStep + 1) % 2;
                actualizarNPCs(true);
                // Only create normal note if NOT in double_tempo mode (double_tempo uses its own loop)
                if (currentStatus.type !== 'double_tempo') {
                    crearNota(false);
                }
                // PenalizaciÃ³n: Si hay demasiadas notas acumuladas, resetear combo
                if (activeNotes.length > 3) {
                    combo = 0;
                    document.getElementById('combo-counter').innerText = "000";
                    document.getElementById('accuracy-feedback').innerText = "OVERLOAD";
                    document.getElementById('accuracy-feedback').style.color = "var(--miss)";
                    // Eliminar todas las notas acumuladas
                    activeNotes.forEach(note => note.el.remove());
                    activeNotes = [];
                }
                canMove = true;
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'loop:after',message:'canMove set to true',data:{canMove,activeNotesCount:activeNotes.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                // #endregion
            }, time);
        }, "4n");

        // Double tempo loop: creates notes at 1/4 and 3/4 steps (on-beat and off-beat)
        // Runs at 8n intervals to create notes at both positions within each 4n period
        let doubleTempoNoteCounter = 0;
        const doubleTempoLoop = new Tone.Loop((time) => {
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'doubleTempoLoop:entry',message:'Double tempo loop triggered',data:{beatCounter,isStarted,activeNotesCount:activeNotes.length,noteCounter:doubleTempoNoteCounter},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B,E'})}).catch(()=>{});
            // #endregion
            if (!isStarted || currentStatus.type !== 'double_tempo') return;
            
            Tone.Draw.schedule(() => {
                // Alternate between 1/4 (on-beat) and 3/4 (off-beat) notes
                const isOffbeat = (doubleTempoNoteCounter % 2 === 1);
                crearNota(isOffbeat, true); // second param indicates double_tempo mode
                canMove = true;
                doubleTempoNoteCounter++;
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'doubleTempoLoop:noteCreated',message:'Double tempo note created',data:{isOffbeat,activeNotesCount:activeNotes.length,noteCounter:doubleTempoNoteCounter},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B,E'})}).catch(()=>{});
                // #endregion
            }, time);
        }, "8n");

        function autoAdjustBpm() {
            config.bpm = Math.min(Math.max(parseInt(config.bpm) + (Math.random() > 0.5 ? 5 : -5), 60), 220);
            Tone.Transport.bpm.rampTo(config.bpm, 1);
            document.getElementById('bpm-display').innerText = `BPM: ${Math.round(config.bpm)}`;
        }

        // --- CORE LOGIC ---
        function generarLayout() {
            obstacles = []; const g = config.grid;
            blueZone = { x: Math.floor(g*0.4), y: Math.floor(g*0.4), w: Math.floor(g*0.2)+2, h: Math.floor(g*0.2)+2 };
            
            if (appearance.dj) obstacles.push({x: Math.floor(g/2), y: 1, type: 'dj'});
            if (appearance.barman) obstacles.push({x: g-3, y: Math.floor(g/2), char: '(à² _à² )æ—¦', color: '#aaa'});
            if (appearance.sofas) {
                for(let i=2; i<6; i++) obstacles.push({x: i, y: g-3, char: 'TTT', color: '#01CDFE'});
            }
            if (appearance.tables) {
                obstacles.push({x: 3, y: g-5, char: 'â”¬â”€â”¬', color: '#01CDFE'});
            }
            if (appearance.screens) {
                obstacles.push({x: Math.floor(g*0.2), y: 0, char: '[REC]', color: '#500'});
                obstacles.push({x: Math.floor(g*0.8), y: 0, char: '[REC]', color: '#500'});
            }
            if (appearance.sidebars) {
                for(let y=Math.floor(g*0.3); y<Math.floor(g*0.7); y++) obstacles.push({x: 1, y: y, char: 'â–’', color: '#01CDFE'});
            }
            if (appearance.smoking) obstacles.push({x: g-4, y: g-3, char: '(SS)', color: '#01CDFE'});
            if (appearance.wc) obstacles.push({x: 1, y: g-2, char: '[WC]', color: '#fff'});
        }

        function isOccupied(x, y) {
            if (x < 0 || x >= config.grid || y < 0 || y >= config.grid) return true;
            if (config.collision && obstacles.some(o => o.x === x && o.y === y)) return true;
            return false;
        }

        // Helper function to check if position is occupied by another NPC
        function isNPCOccupied(x, y, selfNpc) {
            if (typeof config.npcCollision === 'undefined' || !config.npcCollision) return false;
            return npcs.some(n => n !== selfNpc && n.x === x && n.y === y);
        }

        // Helper function to check if position is valid for NPC movement (obstacles + other NPCs)
        function isNPCBlocked(x, y, selfNpc) {
            if (isOccupied(x, y)) return true; // Check obstacles and bounds
            if (isNPCOccupied(x, y, selfNpc)) return true; // Check other NPCs
            return false;
        }

// === CORRAL HELPER: CHECK IF TILE IS INSIDE BLUE ZONE ===
        function isInsideBlueZone(x, y) {
            return (
                x >= blueZone.x &&
                x < blueZone.x + blueZone.w &&
                y >= blueZone.y &&
                y < blueZone.y + blueZone.h
            );
        }


        function reiniciarEscena() {
            player = { x: 2, y: 2 }; npcs = [];
            for(let i=0; i<config.npcCount; i++) {
                let x, y, attempts = 0;
                do { 
                    x = Math.floor(Math.random()*config.grid); 
                    y = Math.floor(Math.random()*config.grid); 
                    attempts++;
                } while((isOccupied(x, y) || isNPCOccupied(x, y, null)) && attempts < 100);
                if (attempts < 100) {
                    npcs.push({ x, y, color: 'red', char: '(à² _à² )', dir: 1 });
                }
            }
            activePowerUpsOnMap = [];
        }

        function spawnPowerUps() {
            const now = Date.now();
            Object.keys(puConfig).forEach(id => {
                if (puConfig[id].enabled && (now - puConfig[id].last > puConfig[id].rate * 1000)) {
                    let x, y; do { x=Math.floor(Math.random()*config.grid); y=Math.floor(Math.random()*config.grid); } while(isOccupied(x,y));
                    activePowerUpsOnMap.push({ x, y, id });
                    puConfig[id].last = now;
                }
            });
        }

        function actualizarNPCs(onKick) {
    // #region agent log
    fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'actualizarNPCs:entry',message:'Updating NPCs',data:{onKick,combo,npcCount:npcs.length,npcCollision:config.npcCollision},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
    // #endregion
    npcs.forEach(n => {
        const inZone = isInsideBlueZone(n.x, n.y);
        
        if(inZone) {
            n.color = '#0ff'; n.char = '(*^Ï‰^*)';
            if (onKick && Math.random() > 0.6) {
                const d = [[1,0],[-1,0],[0,1],[0,-1]][Math.floor(Math.random()*4)];
                const nx = n.x + d[0], ny = n.y + d[1];
                if (!isNPCBlocked(nx, ny, n) && isInsideBlueZone(nx, ny)) {
                    n.x = nx; n.y = ny; n.dir = d[0] || n.dir;
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'actualizarNPCs:moveInZone',message:'NPC moved in zone',data:{npcX:n.x,npcY:n.y},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                    // #endregion
                } else {
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'actualizarNPCs:blockedInZone',message:'NPC blocked in zone',data:{nx,ny,obstacle:isOccupied(nx,ny),npc:isNPCOccupied(nx,ny,n)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                    // #endregion
                }
            }
        } else if(onKick && combo > 0) { // <--- SOLO SIGUEN SI HAY COMBO
            const dist = Math.sqrt(Math.pow(n.x-player.x,2)+Math.pow(n.y-player.y,2));
            if (dist < config.followRadius) {
                n.color='#ffa500'; n.char='(â€¢_â€¢)>';
                let dx = n.x < player.x ? 1 : (n.x > player.x ? -1 : 0);
                let dy = n.y < player.y ? 1 : (n.y > player.y ? -1 : 0);
                if(!isNPCBlocked(n.x+dx, n.y+dy, n)) { 
                    n.x+=dx; n.y+=dy; n.dir=dx||n.dir; 
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'actualizarNPCs:moveFollow',message:'NPC moved following',data:{npcX:n.x,npcY:n.y},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                    // #endregion
                } else {
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'actualizarNPCs:blockedFollow',message:'NPC blocked following',data:{nx:n.x+dx,ny:n.y+dy,obstacle:isOccupied(n.x+dx,n.y+dy),npc:isNPCOccupied(n.x+dx,n.y+dy,n)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                    // #endregion
                }
            } else {
                n.color='red'; n.char='(à² _à² )';
            }
        } else { 
            // SI NO HAY COMBO O ESTÃN LEJOS
            n.color='red'; n.char='(à² _à² )'; 
        }
    });
}
        function crearNota(isOffbeat, isDoubleTempo = false) {
    // #region agent log
    fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'crearNota:entry',message:'Creating note',data:{isOffbeat,isDoubleTempo,isStarted,activeNotesCount:activeNotes.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{});
    // #endregion
    if(!isStarted) return;
    const el = document.createElement('div'); el.className = 'note';
    
    // Visual styling for different note types
    if(isDoubleTempo) {
        if(isOffbeat) {
            // 3/4 step note (off-beat in double tempo) - cyan border
            el.style.border = "3px solid var(--excellent)";
            el.style.background = "rgba(0, 255, 255, 0.3)";
            el.style.height = "20px";
        } else {
            // 1/4 step note (on-beat in double tempo) - bright white
            el.style.border = "3px solid #ffffff";
            el.style.background = "rgba(255, 255, 255, 0.5)";
            el.style.height = "25px";
        }
    } else if(isOffbeat) {
        // Regular off-beat note
        el.style.border = "2px solid var(--excellent)";
        el.style.height = "12px";
    }
    
    document.getElementById('zona-beat').appendChild(el);
    
    // Guardamos el objeto de la nota
    const obj = { el, isOffbeat, isDoubleTempo }; 
    activeNotes.push(obj);
    // #region agent log
    fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'crearNota:afterPush',message:'Note added to array',data:{activeNotesCount:activeNotes.length,objId:obj.el.id||'no-id',isDoubleTempo},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
    // #endregion

    // Velocidad de nota ajustable (mÃ¡s rÃ¡pido = mÃ¡s difÃ­cil)
    const noteDuration = config.noteSpeed || 900;
    const noteWindow = config.noteWindow || 0.75; // Ventana de timing mÃ¡s pequeÃ±a (75% en lugar de 90%)
    const anim = el.animate([{left:'450px'}, {left:'30px', offset:noteWindow}, {left:'-50px'}], {duration:noteDuration});

    anim.onfinish = () => {
        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'crearNota:onfinish',message:'Note animation finished',data:{activeNotesCount:activeNotes.length,stillInArray:activeNotes.includes(obj),comboBefore:combo,isDoubleTempo},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C,D'})}).catch(()=>{});
        // #endregion
        // Si la nota llega al final y sigue en el array, el jugador no la pulsÃ³: ES UN MISS
        if(activeNotes.includes(obj)) { 
            combo = 0; 
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'crearNota:miss',message:'MISS detected - combo reset',data:{combo,activeNotesCountBefore:activeNotes.length,isDoubleTempo},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
            // #endregion
            document.getElementById('combo-counter').innerText = "000";
            document.getElementById('accuracy-feedback').innerText = "MISS";
            document.getElementById('accuracy-feedback').style.color = "var(--miss)";
            activeNotes.shift(); 
        }
        el.remove();
    };
}
        function updateHUD() {
            if (currentStatus.beats > 0) {
                currentStatus.beats--;
                document.getElementById('status-hud').style.display = 'flex';
                document.getElementById('status-label').innerText = `EFECTO: ${currentStatus.label}`;
                document.getElementById('progress-fill').style.width = (currentStatus.beats / currentStatus.maxBeats * 100) + "%";
                if (currentStatus.type === 'invert_colors' && beatCounter % 2 === 0) document.getElementById('game-container').classList.toggle('inverted');
                if (currentStatus.type === 'shake_screen') {
                    const i = 10; document.getElementById('game-container').style.transform = `translate(${(Math.random()-0.5)*i}px, ${(Math.random()-0.5)*i}px)`;
                }
                if (currentStatus.type === 'tilt_screen') { document.getElementById('game-container').style.transform = `rotate(${Math.sin(beatCounter)*5}deg)`; }
                
                // Manage double_tempo loop
                if (currentStatus.type === 'double_tempo' && !doubleTempoLoop.state) {
                    doubleTempoLoop.start(0);
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'updateHUD:startDoubleTempo',message:'Double tempo loop started',data:{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B,E'})}).catch(()=>{});
                    // #endregion
                }
            } else {
                // Stop double_tempo loop when effect ends
                if (currentStatus.type === 'double_tempo' && doubleTempoLoop.state) {
                    doubleTempoLoop.stop();
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'updateHUD:stopDoubleTempo',message:'Double tempo loop stopped',data:{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B,E'})}).catch(()=>{});
                    // #endregion
                }
                currentStatus.type = null; document.getElementById('status-hud').style.display = 'none';
                document.getElementById('game-container').classList.remove('inverted');
                document.getElementById('game-container').style.transform = 'none';
            }
            document.getElementById('combo-counter').innerText = combo.toString().padStart(3, '0');
        }

        // --- RENDER ---
        function draw() {
            const cw = 450/config.grid, ch = 350/config.grid;
            ctx.clearRect(0,0,450,350);
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,450,350);

            // Grid y Corral
            ctx.fillStyle = "rgba(0, 150, 255, 0.4)";
            ctx.fillRect(blueZone.x*cw, blueZone.y*ch, blueZone.w*cw, blueZone.h*ch);

            // Lasers (V5)
            if (appearance.lasers && isStarted && djStep === 0) {
                ctx.strokeStyle = `hsl(${Math.random()*360}, 100%, 50%)`;
                ctx.beginPath(); ctx.moveTo(225, 0); ctx.lineTo(Math.random()*450, 350); ctx.stroke();
            }

            // Power-Ups
            activePowerUpsOnMap.forEach(p => {
                const color = PU_TYPES[p.id].color;
                ctx.strokeStyle = color; ctx.strokeRect(p.x*cw+1, p.y*ch+1, cw-2, ch-2);
                ctx.fillStyle = color; ctx.font = `${ch*0.8}px Courier`; ctx.textAlign="center";
                ctx.fillText(PU_TYPES[p.id].char, (p.x+0.5)*cw, (p.y+0.8)*ch);
            });

            // DecoraciÃ³n
            ctx.font = `${ch}px Courier`; ctx.textAlign="center";
            obstacles.forEach(o => {
                if(o.type === 'dj') { ctx.fillStyle="#fff"; ctx.fillText(djStep ? "(âŒâ– _â– )ãƒŽ" : "(âŒâ– _â– )â”›", (o.x+0.5)*cw, (o.y+1)*ch); }
                else { ctx.fillStyle=o.color; ctx.fillText(o.char, (o.x+0.5)*cw, (o.y+1)*ch); }
            });

            // NPCs
            npcs.forEach(n => { 
                ctx.fillStyle=n.color; ctx.save(); ctx.translate((n.x+0.5)*cw, (n.y+1)*ch); ctx.scale(n.dir, 1);
                ctx.fillText(n.char, 0, 0); ctx.restore();
            });

            // Player
            if(appearance.playerGlow) { ctx.fillStyle="rgba(0,255,0,0.15)"; ctx.fillRect(player.x*cw, player.y*ch, cw, ch); }
            ctx.fillStyle="#0f0"; ctx.fillText(appearance.avatar, (player.x+0.5)*cw, (player.y+1)*ch);

            requestAnimationFrame(draw);
        }

        // --- INPUT ---
        window.addEventListener('keydown', (e) => {
    // #region agent log
    fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'keydown:entry',message:'Key pressed',data:{key:e.key,isStarted,canMove,activeNotesCount:activeNotes.length,combo},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
    // #endregion
    // Si no hay notas activas, no puede haber acierto (LÃ³gica de Steps)
    if(!isStarted || !canMove || activeNotes.length === 0) {
        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'keydown:blocked',message:'Key blocked',data:{isStarted,canMove,activeNotesCount:activeNotes.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
        // #endregion
        return;
    }
    
    const n = activeNotes[0];
    
    // Verificar timing: la nota debe estar cerca del target (ventana de timing mÃ¡s estricta)
    const noteRect = n.el.getBoundingClientRect();
    const targetRect = document.getElementById('beat-target').getBoundingClientRect();
    const noteLeft = noteRect.left;
    const targetLeft = targetRect.left;
    const distance = Math.abs(noteLeft - targetLeft);
    const maxDistance = 60; // Distancia mÃ¡xima permitida (mÃ¡s estricto que antes)
    
    // Si la nota estÃ¡ demasiado lejos del target, es un error de timing
    if (distance > maxDistance) {
        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'keydown:timingError',message:'Timing error - too early/late',data:{distance,maxDistance,combo},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
        // #endregion
        combo = 0;
        document.getElementById('combo-counter').innerText = "000";
        document.getElementById('accuracy-feedback').innerText = "TIMING_ERROR";
        document.getElementById('accuracy-feedback').style.color = "var(--miss)";
        n.el.remove();
        activeNotes.shift();
        canMove = false;
        return;
    }
    let k = e.key;

    // LÃ³gica de Power-Ups de tu cÃ³digo original
    if(currentStatus.type === 'invert_controls') {
        const inv = { ArrowUp:'ArrowDown', ArrowDown:'ArrowUp', ArrowLeft:'ArrowRight', ArrowRight:'ArrowLeft' };
        k = inv[k] || k;
    }

    let nX = player.x, nY = player.y;
    // Double tempo no longer affects step size - it affects note timing instead
    let step = 1;
    if(k==='ArrowUp') nY-=step; 
    if(k==='ArrowDown') nY+=step; 
    if(k==='ArrowLeft') nX-=step; 
    if(k==='ArrowRight') nX+=step;

    if(!isOccupied(nX, nY)) { 
        player.x = nX; 
        player.y = nY; 
        
        // INCREMENTO DE COMBO Y ACTUALIZACIÃ“N VISUAL
        const comboBefore = combo;
        combo++;
        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'keydown:comboInc',message:'Combo incremented',data:{comboBefore,comboAfter:combo,activeNotesCountBefore:activeNotes.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
        // #endregion
        document.getElementById('combo-counter').innerText = combo.toString().padStart(3, '0');
        
        // Feedback de precisiÃ³n basado en quÃ© tan cerca estÃ¡ la nota del target
        const timingAccuracy = 1 - (distance / maxDistance);
        if (timingAccuracy > 0.9) {
            document.getElementById('accuracy-feedback').innerText = "PERFECT!";
            document.getElementById('accuracy-feedback').style.color = "var(--excellent)";
        } else if (timingAccuracy > 0.7) {
            document.getElementById('accuracy-feedback').innerText = "GREAT!";
            document.getElementById('accuracy-feedback').style.color = "var(--great)";
        } else {
            document.getElementById('accuracy-feedback').innerText = "GOOD";
            document.getElementById('accuracy-feedback').style.color = "var(--good)";
        }
        
        // Eliminar nota y bloquear hasta siguiente beat
        n.el.remove(); 
        activeNotes.shift(); 
        canMove = false; 
        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'keydown:afterMove',message:'After move',data:{canMove,activeNotesCount:activeNotes.length,combo},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
        // #endregion

        // DetecciÃ³n de Power-Ups en el mapa (original de tu V9)
        const pIdx = activePowerUpsOnMap.findIndex(p => p.x === player.x && p.y === player.y);
        if(pIdx !== -1) {
            const pu = activePowerUpsOnMap[pIdx];
            // Stop previous double_tempo loop if switching to a different effect
            if (currentStatus.type === 'double_tempo' && typeof doubleTempoLoop !== 'undefined' && doubleTempoLoop.state) {
                doubleTempoLoop.stop();
            }
            currentStatus = { type: puConfig[pu.id].effect, label: EFFECTS_LIST[puConfig[pu.id].effect], beats: puConfig[pu.id].dur, maxBeats: puConfig[pu.id].dur };
            // Start double_tempo loop immediately if this is the double_tempo power-up
            if (currentStatus.type === 'double_tempo' && isStarted && typeof doubleTempoLoop !== 'undefined') {
                doubleTempoLoop.start(0);
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'keydown:startDoubleTempo',message:'Double tempo activated via power-up',data:{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B,E'})}).catch(()=>{});
                // #endregion
            }
            activePowerUpsOnMap.splice(pIdx, 1);
        }
    } else {
        // Si choca con un obstÃ¡culo, se rompe el combo
        combo = 0;
        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'keydown:collision',message:'Collision detected',data:{combo},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
        // #endregion
        document.getElementById('combo-counter').innerText = "000";
        document.getElementById('accuracy-feedback').innerText = "COLLISION";
        document.getElementById('accuracy-feedback').style.color = "var(--miss)";
    }
});
        // --- UI MENUS ---
        function renderPreGameMenu() {
            const container = document.getElementById('pre-game-pu-list'); container.innerHTML = "";
            Object.keys(PU_TYPES).forEach(id => {
                const div = document.createElement('div');
                div.innerHTML = `<label style="color:${PU_TYPES[id].color}"><input type="checkbox" id="pre-${id}" ${puConfig[id].enabled?'checked':''}> ${PU_TYPES[id].char} ${id}</label>`;
                container.appendChild(div);
                document.getElementById(`pre-${id}`).onchange = (e) => puConfig[id].enabled = e.target.checked;
            });
        }

        function initPowerUpMenu() {
            const container = document.getElementById('pu-controls-container'); container.innerHTML = "";
            Object.keys(PU_TYPES).forEach(id => {
                const div = document.createElement('div'); div.className = 'debug-group';
                div.innerHTML = `
                    <label style="color:${PU_TYPES[id].color}">${id} <input type="checkbox" ${puConfig[id].enabled?'checked':''} onchange="puConfig['${id}'].enabled=this.checked"></label>
                    <select onchange="puConfig['${id}'].effect=this.value">
                        ${Object.keys(EFFECTS_LIST).map(eff => `<option value="${eff}" ${puConfig[id].effect===eff?'selected':''}>${EFFECTS_LIST[eff]}</option>`).join('')}
                    </select>
                `;
                container.appendChild(div);
            });
        }

        // --- BINDINGS ---
        document.getElementById('start-btn').onclick = async () => {
            await Tone.start();
            kick = new Tone.MembraneSynth().toDestination();
            snare = new Tone.NoiseSynth({ envelope: { decay: 0.1 } }).toDestination();
            updateKickParams();
            Tone.Transport.bpm.value = config.bpm;
            Tone.Transport.start(); 
            loop.start(0);
            // doubleTempoLoop will start automatically when double_tempo power-up is activated
            isStarted = true; document.getElementById('start-overlay').style.display = 'none';
        };

        const bind = (id, target, prop, callback) => {
            const el = document.getElementById(id);
            if(el.type === 'checkbox') el.onchange = (e) => { target[prop] = e.target.checked; if(callback) callback(); };
            else el.oninput = (e) => { target[prop] = e.target.value; if(callback) callback(); };
        };

        bind('input-grid', config, 'grid', () => { generarLayout(); reiniciarEscena(); });
        bind('input-npc', config, 'npcCount', reiniciarEscena);
        bind('input-bpm', config, 'bpm', () => Tone.Transport.bpm.value = config.bpm);
        bind('input-follow', config, 'followRadius');
        bind('input-tol', config, 'tolerance');
        bind('input-note-speed', config, 'noteSpeed', () => {
            // Actualizar velocidad de notas existentes no es posible, pero nuevas notas usarÃ¡n el nuevo valor
        });
        bind('input-note-window', config, 'noteWindow', () => {
            // Actualizar ventana de timing para nuevas notas
        });
        bind('input-kick-type', config, 'kickType', updateKickParams);
        bind('input-snare-type', config, 'snareType', () => snare.noise.type = config.snareType);
        bind('check-snare-master', config, 'snareEnabled');
        
        // Toggles DecoraciÃ³n
        const deco = ['dj', 'barman', 'sofas', 'tables', 'screens', 'lasers', 'sidebars', 'smoking', 'wc'];
        deco.forEach(id => bind(`check-${id}`, appearance, id, generarLayout));

        document.getElementById('user-avatar').onchange = (e) => appearance.avatar = e.target.value;
        document.getElementById('input-volume').oninput = (e) => Tone.Destination.volume.value = e.target.value;

        const setupPanel = (btn, panel) => {
            document.getElementById(btn).onclick = () => document.getElementById(panel).style.display = 'flex';
            document.getElementById('close-'+panel.split('-')[0]).onclick = () => document.getElementById(panel).style.display = 'none';
        };
        setupPanel('open-appearance', 'appearance-panel');
        setupPanel('open-playlist', 'playlist-panel');
        setupPanel('open-powerups', 'powerup-panel');
        setupPanel('open-debug', 'debug-panel');

        document.getElementById('btn-random-pu').onclick = () => {
            Object.keys(puConfig).forEach(k => puConfig[k].enabled = Math.random() > 0.4);
            renderPreGameMenu();
        };
    </script>


<!-- ===================================================================== -->
<!-- === SAFE ADDITIVE EXTENSION â€“ NO ORIGINAL CODE MODIFIED =============== -->
<!-- ===================================================================== -->

<style>
/* === ADDITIVE: EXTRA VISUAL PRESENCE FOR DECOR === */
.decor-glow {
    text-shadow: 0 0 6px currentColor, 0 0 12px currentColor;
}
</style>

<script>
/* ===================================================================== */
/* === SAFE ADDITIVE EXTENSION BLOCK ==================================== */
/* ===================================================================== */
(function(){

/* ----------------------------------------------------- */
/* 1) DECORATIVE EXTENSIONS + TOGGLES (INSIDE CLUB_DECOR) */
/* ----------------------------------------------------- */

if (typeof appearance === 'object') {
    appearance.neon = true;
    appearance.speakers = true;
    appearance.pillars = false;
    appearance.exit = true;
}

/* Inject new toggles into Appearance panel */
window.addEventListener('load', () => {
    const panel = document.getElementById('appearance-panel');
    if (!panel) return;

    const headers = [...panel.querySelectorAll('h3')];
    const decorHeader = headers.find(h => h.textContent.includes('CLUB_DECOR'));
    if (!decorHeader) return;

    const makeToggle = (id, label) => {
        const div = document.createElement('div');
        div.className = 'debug-group';
        div.innerHTML = `<label>${label}<input type="checkbox" id="check-${id}" checked></label>`;
        decorHeader.insertAdjacentElement('afterend', div);
        document.getElementById(`check-${id}`).onchange = e => {
            appearance[id] = e.target.checked;
            generarLayout();
        };
    };

    makeToggle('neon', 'NEON_SIGNS');
    makeToggle('speakers', 'SPEAKERS');
    makeToggle('pillars', 'PILLARS');
    makeToggle('exit', 'EXIT_SIGN');
});

/* Extend generarLayout safely */
if (typeof generarLayout === 'function') {
    const _gen = generarLayout;
    generarLayout = function(){
        _gen();

        const g = config.grid;

        if (appearance.neon)
            obstacles.push({x:2,y:1,char:'[NEON]',color:'#01CDFE',decor:true});

        if (appearance.speakers)
            obstacles.push({x:0,y:Math.floor(g/2),char:'[|||]',color:'#01CDFE',decor:true});

        if (appearance.pillars)
            for(let y=3;y<g-3;y+=4)
                obstacles.push({x:Math.floor(g/2),y,char:'â•‘',color:'#01CDFE',decor:true});

        if (appearance.exit)
            obstacles.push({x:g-2,y:1,char:'[EXIT]',color:'#00ff00',decor:true});
    };
}

/* ----------------------------------------------------- */
/* 2) SOFAS PROTECT COMBO (SAFE)                          */
/* ----------------------------------------------------- */

function playerOnSofa(){
    return obstacles.some(o =>
        o.char === 'TTT' &&
        o.x === player.x &&
        o.y === player.y
    );
}

/* Prevent combo loss when missing notes */
if (typeof crearNota === 'function') {
    const _crearNota = crearNota;
    crearNota = function(isOffbeat){
        _crearNota(isOffbeat);

        const last = activeNotes[activeNotes.length - 1];
        if (!last) return;

        const origFinish = last.el.getAnimations()[0].onfinish;
        last.el.getAnimations()[0].onfinish = () => {
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sofaProtection:onfinish',message:'Sofa protection check',data:{onSofa:playerOnSofa(),comboBefore:combo,stillInArray:activeNotes.includes(last)},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'D'})}).catch(()=>{});
            // #endregion
            // Only reset combo if note was MISSED (still in array) AND player is NOT on sofa
            // If note was HIT, it's already removed from activeNotes, so don't reset combo
            if (activeNotes.includes(last) && !playerOnSofa()) {
                combo = 0;
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sofaProtection:reset',message:'Combo reset by sofa protection (MISS)',data:{combo},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'D'})}).catch(()=>{});
                // #endregion
            }
            if (origFinish) origFinish();
        };
    };
}

/* ----------------------------------------------------- */
/* 3) SLIDER VALUE LABELS (ALL RANGE INPUTS)              */
/* ----------------------------------------------------- */

window.addEventListener('load', () => {
    document.querySelectorAll('input[type="range"]').forEach(slider => {
        if (slider.dataset.hasValue) return;
        slider.dataset.hasValue = '1';

        const span = document.createElement('span');
        span.className = 'slider-val';
        span.textContent = slider.value;
        slider.parentNode.appendChild(span);

        slider.addEventListener('input', () => {
            span.textContent = slider.value;
        });
    });
});

/* ----------------------------------------------------- */
/* 4) MANUAL BPM SLIDER (NON-DESTRUCTIVE)                 */
/* ----------------------------------------------------- */

window.addEventListener('load', () => {
    const debug = document.getElementById('debug-panel');
    if (!debug) return;

    const wrap = document.createElement('div');
    wrap.className = 'debug-group';
    wrap.innerHTML = `
        <label>MANUAL_BPM_OVERRIDE</label>
        <div style="display:flex;gap:6px;align-items:center">
            <input type="range" min="60" max="240" value="${config.bpm}">
            <span class="slider-val">${config.bpm}</span>
        </div>
    `;
    debug.appendChild(wrap);

    const slider = wrap.querySelector('input');
    const val = wrap.querySelector('span');

    slider.oninput = () => {
        val.textContent = slider.value;
        config.bpm = Number(slider.value);
        if (window.Tone && Tone.Transport)
            Tone.Transport.bpm.rampTo(config.bpm, 0.2);
        const bpmDisplay = document.getElementById('bpm-display');
        if (bpmDisplay) bpmDisplay.innerText = `BPM: ${Math.round(config.bpm)}`;
    };
});

/* ----------------------------------------------------- */
/* 5) EXTRA VISUAL PRESENCE (DRAW EXTENSION)              */
/* ----------------------------------------------------- */

if (typeof draw === 'function') {
    const _draw = draw;
    draw = function(){
        _draw();

        obstacles.forEach(o=>{
            if(o.decor){
                ctx.save();
                ctx.strokeStyle = o.color;
                ctx.shadowColor = o.color;
                ctx.shadowBlur = 10;
                const cw = 450/config.grid;
                const ch = 350/config.grid;
                ctx.strokeRect(o.x*cw,o.y*ch,cw,ch);
                ctx.restore();
            }
        });
    };
}

})(); 
</script>
<!-- ===================================================================== -->
<!-- === END SAFE ADDITIVE EXTENSION ====================================== -->
<!-- ===================================================================== -->


<!-- ===================================================================== -->
<!-- === SAFE ADDITIVE EXTENSION: MUSIC ROTATION ENGINE =================== -->
<!-- ===================================================================== -->

<script>
(function(){

/* ----------------------------------------------------- */
/* CONFIGURATION                                         */
/* ----------------------------------------------------- */
const ROTATION_BEATS = 32;
const BPM_DELTAS = [3, 5, 10];
const BPM_MIN = 60;
const BPM_MAX = 220;
const BPM_RAMP_TIME = 2; // seconds

let rotationBeatCounter = 0;

/* ----------------------------------------------------- */
/* VISUAL FEEDBACK HELPERS                               */
/* ----------------------------------------------------- */
function flashBpmDisplay(){
    const el = document.getElementById('bpm-display');
    if(!el) return;
    el.style.boxShadow = '0 0 20px var(--playlist-color)';
    el.style.borderColor = 'var(--playlist-color)';
    setTimeout(()=>{
        el.style.boxShadow = '';
        el.style.borderColor = 'var(--playlist-color)';
    },600);
}

function showRotationHUD(text){
    if(!window.currentStatus) return;
    currentStatus = {
        type: 'rotation',
        label: text,
        beats: 8,
        maxBeats: 8
    };
}

/* ----------------------------------------------------- */
/* MUSIC ROTATION LOGIC                                  */
/* ----------------------------------------------------- */
function rotateMusic(){

    /* 1) BPM ROTATION */
    const delta = BPM_DELTAS[Math.floor(Math.random()*BPM_DELTAS.length)];
    const sign = Math.random() > 0.5 ? 1 : -1;
    let targetBpm = config.bpm + delta * sign;

    targetBpm = Math.max(BPM_MIN, Math.min(BPM_MAX, targetBpm));

    config.bpm = targetBpm;

    if (window.Tone && Tone.Transport){
        Tone.Transport.bpm.rampTo(targetBpm, BPM_RAMP_TIME);
    }

    const bpmDisplay = document.getElementById('bpm-display');
    if(bpmDisplay){
        bpmDisplay.innerText = `BPM: ${Math.round(targetBpm)}`;
    }

    flashBpmDisplay();

    /* 2) KICK & SNARE ROTATION */
    const kickTypes = ['deep','tight','electro'];
    const snareTypes = ['white','brown','pink'];

    config.kickType = kickTypes[Math.floor(Math.random()*kickTypes.length)];
    config.snareType = snareTypes[Math.floor(Math.random()*snareTypes.length)];

    if(typeof updateKickParams === 'function') updateKickParams();
    if(window.snare && snare.noise) snare.noise.type = config.snareType;

    /* HUD FEEDBACK */
    showRotationHUD(`TRACK ROTATION`);
}

/* ----------------------------------------------------- */
/* BEAT HOOK (SAFE)                                      */
/* ----------------------------------------------------- */
if (window.Tone && Tone.Transport){

    Tone.Transport.scheduleRepeat((time)=>{
        rotationBeatCounter++;

        if(rotationBeatCounter % ROTATION_BEATS === 0){
            Tone.Draw.schedule(()=>{
                rotateMusic();
            }, time);
        }

    }, "4n");
}

})();
</script>

<!-- ===================================================================== -->
<!-- === END MUSIC ROTATION ENGINE ======================================= -->
<!-- ===================================================================== -->


<!-- ===================================================================== -->
<!-- === SAFE ADDITIVE EXTENSION: NPC COLLISION PATCH ===================== -->
<!-- ===================================================================== -->

<script>
(function(){

/* ----------------------------------------------------- */
/* 1) STATE + TOGGLE DEFAULT                             */
/* ----------------------------------------------------- */

if (typeof config === 'object') {
    config.npcCollision = true; // default ON
}

/* ----------------------------------------------------- */
/* 2) ADD TOGGLE TO DEBUG / SYSTEM MENU                  */
/* ----------------------------------------------------- */

window.addEventListener('load', () => {
    const debugPanel = document.getElementById('debug-panel');
    if (!debugPanel) return;

    const group = document.createElement('div');
    group.className = 'debug-group';
    group.innerHTML = `
        <label>
            NPC_COLLISION_LOCK
            <input type="checkbox" checked>
        </label>
    `;
    debugPanel.appendChild(group);

    const checkbox = group.querySelector('input');
    checkbox.onchange = (e) => {
        config.npcCollision = e.target.checked;
    };
});

/* ----------------------------------------------------- */
/* 3) NPCâ€“NPC COLLISION CHECK                            */
/* ----------------------------------------------------- */

function npcOccupied(x, y, selfNpc){
    return npcs.some(n =>
        n !== selfNpc &&
        n.x === x &&
        n.y === y
    );
}

/* ----------------------------------------------------- */
/* 4) PATCH NPC MOVEMENT (SAFE)                          */
/* ----------------------------------------------------- */



/* ----------------------------------------------------- */
/* 5) ALLOW PLAYER TO PASS THROUGH NPCs                  */
/* ----------------------------------------------------- */

if (typeof isOccupied === 'function') {
    const _isOccupied = isOccupied;

    isOccupied = function(x, y){
        // original collision (walls, decor, bounds)
        if (_isOccupied(x, y)) return true;

        // ignore NPCs entirely for player movement
        return false;
    };
}

})();
</script>

<!-- ===================================================================== -->
<!-- === END NPC COLLISION PATCH ========================================== -->
<!-- ===================================================================== -->


<!-- ===================================================================== -->
<!-- === SAFE ADDITIVE EXTENSION: MOBILE LAYOUT + TOUCH CONTROLS ========== -->
<!-- ===================================================================== -->

<style>
/* 1. RESET PARA MODO MÃ“VIL - Solo cuando el wrapper existe */
body:has(#game-master-wrapper) {
    margin: 0;
    padding: 0;
    width: 100vw;
    height: 100vh;
    overflow: hidden !important;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    background: #000;
    padding-top: 0;
}

/* 2. EL CONTENEDOR MAESTRO QUE FUERZA EL STANDAR LAYOUT */
#game-master-wrapper {
    width: 450px;
    height: auto;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    position: relative;
    transform-origin: top center;
    flex-shrink: 0;
    margin: 0 auto;
    padding-top: 0;
}

/* Ajuste de los elementos originales dentro del wrapper */
#game-master-wrapper #main-view {
    width: 450px !important;
    height: auto !important;
    flex-grow: 0 !important;
    padding: 0 !important;
    margin: 0 !important;
    min-height: auto !important;
}

/* Mobile view adjustments for HUD elements */
@media (max-width: 600px) {
    #bpm-display {
        font-size: 12px;
        padding: 4px 8px;
        top: 10px;
        right: 10px;
        left: auto !important;
        min-width: 70px;
        max-width: 120px;
    }
    #volume-control {
        top: 35px;
        left: 5px;
        padding: 4px 6px;
        gap: 6px;
        max-width: 140px;
        flex-direction: row;
    }
    #volume-control label {
        font-size: 7px;
    }
    #volume-control input[type="range"] {
        width: 80px;
        height: 3px;
    }
    #volume-control input[type="range"]::-webkit-slider-thumb {
        width: 10px;
        height: 10px;
    }
    #volume-control input[type="range"]::-moz-range-thumb {
        width: 10px;
        height: 10px;
    }
    .menu-toggle {
        font-size: 8px;
        padding: 4px 6px;
        top: 5px;
    }
    #open-appearance { left: 5px; }
    #open-playlist { left: 100px; }
    #open-powerups { right: 100px; }
    #open-debug { right: 5px; }
    #touch-toggle-btn {
        top: 20px;
        right: 5px;
        font-size: 10px;
        padding: 6px 10px;
        z-index: 1004;
    }
    .side-panel {
        width: 100vw;
        max-width: 100vw;
    }
}

/* 3. BOTÃ“N TOGGLE */
#touch-toggle-btn {
    position: fixed;
    top: 120px;
    right: 20px;
    padding: 10px 15px;
    background: rgba(0, 0, 0, 0.9);
    border: 2px solid #0ff;
    border-radius: 8px;
    color: #0ff;
    font-family: 'Courier New', Courier, monospace;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    z-index: 1001;
    box-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
    white-space: nowrap;
}

#touch-toggle-btn.active {
    background: #0ff;
    color: #000;
}

/* 4. PANEL TÃCTIL INTEGRADO AL LAYOUT */
#touch-panel {
    display: none; 
    width: 100%;
    height: 220px;
    position: relative;
    margin-top: 20px;
    touch-action: none;
}

.tp-btn {
    position: absolute;
    width: 75px;
    height: 75px;
    background: #111;
    border: 3px solid #0ff;
    border-radius: 50%;
    color: #0ff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    user-select: none;
    touch-action: none;
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
}

.tp-btn:active {
    background: #0ff;
    color: #000;
    transform: scale(0.9);
}

/* CRUZ DE CONTROL */
.tp-up    { top: 0; left: 50%; transform: translateX(-50%); }
.tp-down  { bottom: 0; left: 50%; transform: translateX(-50%); }
.tp-left  { left: 20%; top: 50%; transform: translateY(-50%); }
.tp-right { right: 20%; top: 50%; transform: translateY(-50%); }

</style>

<script>
(function() {
    // 1. Envolver el contenido original en el Scaler - Solo en mÃ³viles
    const isMobile = window.innerWidth <= 600 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    let wrapper = document.getElementById('game-master-wrapper');
    if (!wrapper && isMobile) {
        wrapper = document.createElement('div');
        wrapper.id = 'game-master-wrapper';
        const mainView = document.getElementById('main-view');
        if (mainView && mainView.parentNode) {
            mainView.parentNode.insertBefore(wrapper, mainView);
            wrapper.appendChild(mainView);
        }
    }
    
    // Si no es mÃ³vil o no se creÃ³ el wrapper, no continuar
    if (!wrapper) {
        return;
    }

    // 2. Crear el BotÃ³n Toggle
    const toggleBtn = document.createElement('button');
    toggleBtn.id = 'touch-toggle-btn';
    toggleBtn.innerText = 'MOBILE: OFF';
    document.body.appendChild(toggleBtn);

    // 3. Crear el Panel TÃ¡ctil dentro del Wrapper (debajo del juego)
    const panel = document.createElement('div');
    panel.id = 'touch-panel';
    panel.innerHTML = `
        <div class="tp-btn tp-up">â–²</div>
        <div class="tp-btn tp-down">â–¼</div>
        <div class="tp-btn tp-left">â—€</div>
        <div class="tp-btn tp-right">â–¶</div>
    `;
    wrapper.appendChild(panel);

    // 4. LÃ³gica de Escalado DinÃ¡mico - Solo cuando el panel tÃ¡ctil estÃ¡ activo
    function applyScaling() {
        const isMobileMode = panel.style.display === 'block';
        if (!isMobileMode) {
            wrapper.style.transform = 'none';
            wrapper.style.width = '450px';
            wrapper.style.height = 'auto';
            wrapper.style.transformOrigin = 'top center';
            return;
        }
        
        const targetW = 450;
        const targetH = 850;
        const winW = window.innerWidth;
        const winH = window.innerHeight;
        
        // Calcular escala pero mantener el contenido visible desde el inicio
        const scale = Math.min(winW / targetW, winH / targetH) * 0.95;
        wrapper.style.transform = `scale(${scale})`;
        wrapper.style.transformOrigin = 'top center';
    }

    window.addEventListener('resize', applyScaling);
    // No aplicar escalado inicialmente, solo cuando se active modo mÃ³vil
    applyScaling();

    // 5. FunciÃ³n Toggle + Fullscreen
    toggleBtn.onclick = async () => {
        const isActivating = (panel.style.display === '' || panel.style.display === 'none');
        
        if (isActivating) {
            // Ocultar elementos HUD innecesarios en modo mÃ³vil
            const volumeControl = document.getElementById('volume-control');
            const bpmDisplay = document.getElementById('bpm-display');
            const menuButtons = document.querySelectorAll('.menu-toggle');
            
            if (volumeControl) volumeControl.style.display = 'none';
            if (bpmDisplay) bpmDisplay.style.display = 'none';
            menuButtons.forEach(btn => btn.style.display = 'none');
            
            // Intentar entrar en pantalla completa
            try {
                const docEl = document.documentElement;
                if (docEl.requestFullscreen) await docEl.requestFullscreen();
                else if (docEl.webkitRequestFullscreen) await docEl.webkitRequestFullscreen();
                else if (docEl.mozRequestFullScreen) await docEl.mozRequestFullScreen();
                else if (docEl.msRequestFullscreen) await docEl.msRequestFullscreen();
            } catch (e) { console.log("Fullscreen blocked"); }
            
            panel.style.display = 'block';
            toggleBtn.innerText = 'MOBILE: ON';
        } else {
            // Restaurar elementos HUD al salir de modo mÃ³vil
            const volumeControl = document.getElementById('volume-control');
            const bpmDisplay = document.getElementById('bpm-display');
            const menuButtons = document.querySelectorAll('.menu-toggle');
            
            if (volumeControl) volumeControl.style.display = '';
            if (bpmDisplay) bpmDisplay.style.display = '';
            menuButtons.forEach(btn => btn.style.display = '');
            
            if (document.exitFullscreen) document.exitFullscreen().catch(()=> {});
            else if (document.webkitExitFullscreen) document.webkitExitFullscreen().catch(()=> {});
            else if (document.mozCancelFullScreen) document.mozCancelFullScreen().catch(()=> {});
            else if (document.msExitFullscreen) document.msExitFullscreen().catch(()=> {});
            
            panel.style.display = 'none';
            toggleBtn.innerText = 'MOBILE: OFF';
        }
        
        toggleBtn.classList.toggle('active');
        setTimeout(applyScaling, 300); // Re-ajustar tras cambio de UI
    };
    
    // Manejar salida de pantalla completa por otros medios
    const handleFullscreenChange = () => {
        const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || 
                                document.mozFullScreenElement || document.msFullscreenElement);
        if (!isFullscreen) {
            // Restaurar elementos si se sale de pantalla completa
            const volumeControl = document.getElementById('volume-control');
            const bpmDisplay = document.getElementById('bpm-display');
            const menuButtons = document.querySelectorAll('.menu-toggle');
            const panel = document.getElementById('touch-panel');
            
            if (panel && panel.style.display === 'block') {
                if (volumeControl) volumeControl.style.display = '';
                if (bpmDisplay) bpmDisplay.style.display = '';
                menuButtons.forEach(btn => btn.style.display = '');
                panel.style.display = 'none';
                toggleBtn.innerText = 'MOBILE: OFF';
                toggleBtn.classList.remove('active');
            }
        }
    };
    
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.addEventListener('mozfullscreenchange', handleFullscreenChange);
    document.addEventListener('MSFullscreenChange', handleFullscreenChange);

    // 6. LÃ³gica de Teclas (Mapping)
    const keyMap = {
        'tp-up': 'ArrowUp',
        'tp-down': 'ArrowDown',
        'tp-left': 'ArrowLeft',
        'tp-right': 'ArrowRight'
    };

    panel.querySelectorAll('.tp-btn').forEach(btn => {
        const key = keyMap[btn.classList[1]];
        
        const triggerEvent = (type) => {
            window.dispatchEvent(new KeyboardEvent(type, {
                key: key,
                keyCode: (key === 'ArrowUp' ? 38 : key === 'ArrowDown' ? 40 : key === 'ArrowLeft' ? 37 : 39),
                bubbles: true
            }));
        };

        btn.addEventListener('touchstart', (e) => { e.preventDefault(); triggerEvent('keydown'); }, {passive: false});
        btn.addEventListener('touchend', (e) => { e.preventDefault(); triggerEvent('keyup'); }, {passive: false});
    });

    // Bloquear gestos del sistema
    document.addEventListener('touchstart', (e) => {
        if (e.touches.length > 1) e.preventDefault();
    }, { passive: false });

})();
</script>

<!-- ===================================================================== -->
<!-- === END FINAL MOBILE LAYOUT SYSTEM ================================== -->
<!-- ===================================================================== -->


<script>
(function() {
    /* 1. MAPEO SIMPLIFICADO (SOLO HORIZONTAL) */
    const skinOrientations = {
        '(âŒâ– _â– )': { 'ArrowLeft': '<(â– _â–  )', 'ArrowRight': '( â– _â– )>' },
        '(^o^)':   { 'ArrowLeft': '<(^o^ )', 'ArrowRight': '( ^o^)>' },
        '(â—•â€¿â—•)':   { 'ArrowLeft': '<(â—•â€¿â—• )', 'ArrowRight': '( â—•â€¿â—•)>' },
        'd(-_-)b': { 'ArrowLeft': '<d(-_-)',  'ArrowRight': '(-_-)b>' }
    };

    /* 2. CAPTURA DE DIRECCIÃ“N (SOLO SI ES IZQUIERDA O DERECHA) */
    window.addEventListener('keydown', (e) => {
        // Solo actualizamos la orientaciÃ³n si el movimiento es horizontal
        if(e.key === "ArrowLeft" || e.key === "ArrowRight") {
            player.lastDir = e.key;
        }
        // Si es Arriba o Abajo, no hacemos nada, conservando la direcciÃ³n anterior
    }, { capture: true });

    /* 3. INYECCIÃ“N EN EL MOTOR DE DIBUJO (DRAW) */
    if (typeof draw === 'function') {
        const _originalDraw = draw;
        draw = function() {
            _originalDraw(); 

            const cw = 450/config.grid, ch = 350/config.grid;
            
            // Redibujar Corral Cian NeÃ³n (Mantenemos la mejora visual)
            ctx.fillStyle = 'rgba(0, 255, 255, 0.15)';
            ctx.fillRect(blueZone.x*cw, blueZone.y*ch, blueZone.w*cw, blueZone.h*ch);
            ctx.strokeStyle = '#00ffff';
            ctx.lineWidth = 3;
            ctx.strokeRect(blueZone.x*cw, blueZone.y*ch, blueZone.w*cw, blueZone.h*ch);

            // SOBRE-DIBUJAR AL JUGADOR
            ctx.fillStyle = "#000"; 
            ctx.fillRect(player.x*cw, player.y*ch, cw, ch); 

            if(appearance.playerGlow) { 
                ctx.fillStyle="rgba(0,255,0,0.15)"; 
                ctx.fillRect(player.x*cw, player.y*ch, cw, ch); 
            }

            const baseSkin = appearance.avatar;
            // Si hay una orientaciÃ³n horizontal guardada, la usamos. Si no, el skin base.
            const orientedChar = (skinOrientations[baseSkin] && player.lastDir) 
                ? skinOrientations[baseSkin][player.lastDir] 
                : baseSkin;

            ctx.fillStyle = "#0f0";
            ctx.font = `${ch}px Courier`;
            ctx.textAlign = "center";
            ctx.fillText(orientedChar, (player.x + 0.5) * cw, (player.y + 0.9) * ch);
        };
    }

    /* 4. MEJORA DE COLORES DE MUEBLES */
    if (typeof generarLayout === 'function') {
        const _originalGen = generarLayout;
        generarLayout = function() {
            _originalGen();
            if(typeof obstacles !== 'undefined') {
                obstacles.forEach(o => {
                    if(o.char === 'TTT') o.color = '#FF71CE'; 
                    if(o.char === 'â”¬â”€â”¬') o.color = '#FFFB00'; 
                });
            }
        };
        generarLayout();
    }
})();
</script>


</body>

</html>


