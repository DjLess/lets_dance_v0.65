<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm Grid: Industrial ASCII Club - ULTIMATE CONSOLIDATED V9</title>
    <style>
        :root {
            --bg-color: #050505;
            --accent-color: #00ff00;
            --excellent: #00ffff;
            --great: #adff2f;
            --good: #ffd700;
            --miss: #ff4500;
            --playlist-color: #ff00ff;
            --powerup-color: #ffff00;
            --panel-bg: rgba(10, 10, 10, 0.98);
            --border-color: #333;
            --terminal-font: 'Courier New', Courier, monospace;
        }

        body {
            background-color: var(--bg-color);
            color: #eee;
            font-family: var(--terminal-font);
            display: flex;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            text-transform: uppercase;
        }

        #main-view {
            flex-grow: 1; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            position: relative;
            padding: 20px;
            box-sizing: border-box;
            min-height: 100vh;
        }

        /* PANELES LATERALES */
        .side-panel {
            position: fixed; top: 0; width: 300px; max-width: 90vw; height: 100vh;
            background: var(--panel-bg); border: 1px solid var(--border-color);
            padding: 20px; display: none; flex-direction: column;
            gap: 8px; overflow-y: auto; z-index: 2000; backdrop-filter: blur(8px);
            box-sizing: border-box;
        }
        #debug-panel { right: 0; border-left: 1px solid var(--accent-color); }
        #appearance-panel { left: 0; border-right: 1px solid var(--excellent); }
        #playlist-panel { 
            left: 50%; 
            transform: translateX(-50%); 
            border: 1px solid var(--playlist-color); 
            height: auto; 
            max-height: 80vh;
            top: 60px; 
            border-radius: 5px; 
        }
        #powerup-panel { 
            left: 50%; 
            transform: translateX(-50%); 
            border: 1px solid var(--powerup-color); 
            height: auto; 
            max-height: 80vh;
            top: 60px; 
            border-radius: 5px; 
        }

        .debug-group { 
            display: flex; flex-direction: column; gap: 4px; 
            background: #000; padding: 8px; border: 1px solid #222;
        }
        .debug-group label { font-size: 9px; letter-spacing: 1px; color: #888; display: flex; justify-content: space-between; align-items: center; }

        h3 { font-size: 11px; margin: 5px 0; letter-spacing: 2px; border-bottom: 1px solid #333; padding-bottom: 5px; color: #fff; }

        /* UI */
        #ui-layer { 
            text-align: center; 
            margin-bottom: 10px; 
            min-width: 450px; 
            position: relative; 
            z-index: 50; 
            margin-top: 20px;
        }
        #combo-counter { 
            font-size: 42px; 
            color: var(--accent-color); 
            font-weight: 900; 
            margin: 0; 
            text-shadow: 0 0 10px var(--accent-color); 
            line-height: 1;
        }
        #accuracy-feedback { 
            font-size: 12px; 
            letter-spacing: 4px; 
            height: 20px; 
            margin-top: 5px; 
            font-weight: bold; 
            min-height: 20px;
        }
        
        #status-hud { 
            font-size: 11px; color: var(--powerup-color); background: rgba(0, 0, 0, 0.9); 
            padding: 10px; border: 1px solid var(--powerup-color); margin-top: 10px; 
            display: none; flex-direction: column; align-items: center; gap: 5px;
            width: 450px;
            margin-left: auto;
            margin-right: auto;
        }
        .progress-bar-container { width: 100%; height: 4px; background: #333; position: relative; }
        #progress-fill { height: 100%; background: var(--powerup-color); width: 100%; transition: width 0.1s linear; }

        /* JUEGO */
        #bpm-display { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            font-size: 20px; 
            color: var(--playlist-color); 
            border: 1px solid var(--playlist-color); 
            padding: 5px 12px; 
            background: rgba(0,0,0,0.9); 
            z-index: 100; 
            min-width: 100px;
            text-align: center;
        }
        #volume-control { 
            position: fixed; 
            top: 70px; 
            left: 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: flex-start;
            gap: 4px; 
            background: rgba(0,0,0,0.9); 
            padding: 8px 10px; 
            border: 1px solid #333; 
            z-index: 100; 
            min-width: 140px;
            max-width: 180px;
        }
        #volume-control label {
            font-size: 8px;
            white-space: nowrap;
            margin: 0;
            width: 100%;
        }
        #volume-control input[type="range"] {
            width: 100%;
            height: 4px;
            margin: 0;
            -webkit-appearance: none;
            appearance: none;
            background: #333;
            outline: none;
        }
        #volume-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: var(--accent-color);
            cursor: pointer;
            border-radius: 50%;
        }
        #volume-control input[type="range"]::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: var(--accent-color);
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }

        #game-container { width: 450px; border: 1px solid #333; background: #000; position: relative; transition: transform 0.05s ease-out; }
        #zona-juego { display: block; width: 450px; height: 350px; }
        #zona-beat { 
            width: 450px; 
            height: 100px; 
            background: linear-gradient(to bottom, #0a0a0a, #000); 
            border-top: 2px solid #222; 
            position: relative; 
            overflow: hidden; 
        }
        #beat-target { position: absolute; left: 30px; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; border: 2px solid #444; }
        .note { 
            position: absolute; 
            top: 50%; 
            transform: translateY(-50%); 
            width: 30px; 
            height: 30px; 
            border-radius: 6px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            font-size: 16px; 
            z-index: 5; 
            transition: transform 0.1s ease;
            will-change: transform, left;
        }
        
        /* DDR - EFECTO AL GOLPEAR NOTA */
        .note.hit {
            transform: translateY(-50%) scale(1.4);
            opacity: 0.8;
            filter: brightness(1.5);
        }
        
        .inverted { filter: invert(1) hue-rotate(180deg); }

        /* BOTONES Y INPUTS */
        .btn { padding: 8px; font-weight: bold; cursor: pointer; border: 1px solid #444; background: #111; color: #eee; font-family: var(--terminal-font); font-size: 10px; }
        .btn:hover { background: #222; border-color: #888; }
        .menu-toggle { 
            position: fixed; 
            top: 20px; 
            background: rgba(0,0,0,0.9); 
            border: 1px solid #333; 
            color: #777; 
            z-index: 1500; 
            white-space: nowrap;
        }
        input[type="range"], select { background: #000; color: #fff; border: 1px solid #333; }
        
        /* Menu button positioning to avoid overlaps */
        #open-appearance { left: 20px; }
        #open-playlist { left: 180px; }
        #open-powerups { right: 180px; }
        #open-debug { right: 20px; }

        /* OVERLAY INICIAL */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.96); z-index: 3000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px;
            backdrop-filter: blur(10px); padding: 20px;
        }
        #pre-game-pu-list {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 620px;
            background: #111; padding: 20px; border: 1px solid #444;
        }
    </style>
</head>
<body>

    <div id="bpm-display">BPM: 120</div>

    <div id="volume-control">
        <label style="color:var(--accent-color)">MASTER</label>
        <input type="range" id="input-volume" min="-60" max="0" value="-10">
        <label style="color:#00ffff; margin-top:4px;">KICK</label>
        <input type="range" id="input-kick-volume" min="-60" max="0" value="0" step="1">
        <label style="color:#ff00ff; margin-top:4px;">SNARE</label>
        <input type="range" id="input-snare-volume" min="-60" max="0" value="-50" step="1">
    </div>

    <button id="open-appearance" class="btn menu-toggle">[ DISEÃ‘O_ASCII ]</button>
    <button id="open-playlist" class="btn menu-toggle">[ PLAYLIST_PRO ]</button>
    <button id="open-powerups" class="btn menu-toggle" style="border-color: var(--powerup-color);">[ POWER_UPS ]</button>
    <button id="open-debug" class="btn menu-toggle">[ SISTEMA_CORE ]</button>

    <div id="appearance-panel" class="side-panel">
        <button id="close-appearance" class="btn">_CERRAR_</button>
        <h3 style="color:var(--excellent)">VISUAL_CONFIG</h3>
        <div class="debug-group"><label>GRID_SIZE</label><input type="range" id="input-grid" min="16" max="64" step="2" value="32"></div>
        <div class="debug-group"><label>USER_AVATAR</label><select id="user-avatar"><option value="(âŒâ– _â– )">COOL</option><option value="(^o^)">HYPE</option><option value="(â—•â€¿â—•)">KAWAII</option><option value="d(-_-)b">DJ_SET</option></select></div>
        <div class="debug-group"><label>RHYTHM_HINTS</label><input type="checkbox" id="check-hints" checked></div>
        <div class="debug-group"><label>PLAYER_GLOW</label><input type="checkbox" id="check-player-glow" checked></div>
        
        <h3 style="color:var(--good)">CLUB_DECOR (OBJECTS)</h3>
        <div class="debug-group"><label>DJ_BOOTH</label><input type="checkbox" id="check-dj" checked></div>
        <div class="debug-group"><label>BARTENDER</label><input type="checkbox" id="check-barman" checked></div>
        <div class="debug-group"><label>VIP_SOFAS</label><input type="checkbox" id="check-sofas" checked></div>
        <div class="debug-group"><label>TABLES</label><input type="checkbox" id="check-tables" checked></div>
        <div class="debug-group"><label>SCREENS</label><input type="checkbox" id="check-screens" checked></div>
        <div class="debug-group"><label>LASERS</label><input type="checkbox" id="check-lasers" checked></div>
        <div class="debug-group"><label>SIDE_BARS</label><input type="checkbox" id="check-sidebars" checked></div>
        <div class="debug-group"><label>SMOKING_ZONE</label><input type="checkbox" id="check-smoking" checked></div>
        <div class="debug-group"><label>RESTROOMS</label><input type="checkbox" id="check-wc" checked></div>
        
        <h3 style="color:var(--excellent)">NEW_DECOR_V2</h3>
        <div class="debug-group"><label>DJ_TABLE</label><input type="checkbox" id="check-dj-table" checked></div>
        <div class="debug-group"><label>EXTRA_LASERS (4x)</label><input type="checkbox" id="check-extra-lasers" checked></div>
        <div class="debug-group"><label>ADVANCED_LASER</label><input type="checkbox" id="check-advanced-laser" checked></div>
        <div class="debug-group"><label>LED_AMBIENT</label><input type="checkbox" id="check-led-lights" checked></div>
        <div class="debug-group"><label>LIGHTS</label><input type="checkbox" id="check-lights" checked></div>
        <div class="debug-group"><label>SMOKE_MACHINE</label><input type="checkbox" id="check-smoke-machine" checked></div>
        <div class="debug-group"><label>SPEAKERS</label><input type="checkbox" id="check-speakers" checked></div>
        <div class="debug-group"><label>BAR_COUNTER</label><input type="checkbox" id="check-bar-counter" checked></div>
    </div>

    <div id="playlist-panel" class="side-panel">
        <button id="close-playlist" class="btn">_CERRAR_</button>
        <h3 style="color:var(--playlist-color)">AUDIO_SYNC_PRO</h3>
        <div class="debug-group"><label>AUTO_BPM</label><input type="checkbox" id="playlist-auto-bpm" checked></div>
        <div class="debug-group"><label>CHANGE_FREQ</label><input type="range" id="input-pl-freq" min="4" max="64" step="4" value="16"></div>
        <div class="debug-group"><label>KICK_TYPE</label><select id="input-kick-type"><option value="deep">DEEP_SUB</option><option value="tight">TIGHT_POP</option><option value="electro">ELECTRO</option></select></div>
        <div class="debug-group"><label>SNARE_TYPE</label><select id="input-snare-type"><option value="white">WHITE_NOISE</option><option value="brown">BROWN_HEAVY</option><option value="pink">PINK_SHARP</option></select></div>
        <div class="debug-group"><label>SNARE_ENABLED</label><input type="checkbox" id="check-snare-master" checked></div>
    </div>

    <div id="powerup-panel" class="side-panel">
        <button id="close-powerup" class="btn">_CERRAR_</button>
        <h3 style="color:var(--powerup-color)">POWER_UP_CONFIG</h3>
        <div id="pu-controls-container"></div>
    </div>

    <div id="debug-panel" class="side-panel">
        <button id="close-debug" class="btn">_CERRAR_</button>
        <h3 style="color:var(--accent-color)">SISTEMA_V3_CORE</h3>
        <div class="debug-group"><label>NPC_COUNT</label><input type="range" id="input-npc" min="1" max="60" value="15"></div>
        <div class="debug-group"><label>FOLLOW_RAD</label><input type="range" id="input-follow" min="3" max="30" value="9"></div>
        <div class="debug-group"><label>SYNC_TOLERANCE</label><input type="range" id="input-tol" min="50" max="300" value="100"></div>
        <div class="debug-group"><label>NOTE_SPEED</label><input type="range" id="input-note-speed" min="600" max="1500" step="50" value="900"></div>
        <div class="debug-group"><label>TIMING_WINDOW</label><input type="range" id="input-note-window" min="0.5" max="0.95" step="0.05" value="0.75"></div>
        <div class="debug-group"><label>MANUAL_BPM</label><input type="range" id="input-bpm" min="60" max="250" value="120"></div>
        <div class="debug-group"><label>COLLISION_SYSTEM</label><input type="checkbox" id="check-collision" checked></div>
        <button class="btn" style="border-color:#500; color:#f55; margin-top:10px;" onclick="reiniciarEscena()">_FORCE_RESET_SYSTEM</button>
    </div>

    <div id="main-view">
        <div id="start-overlay">
            <h1 style="color:var(--accent-color); letter-spacing: 5px;">RHYTHM_GRID_ULTIMATE</h1>
            <div id="objective-box" style="font-size: 10px; color: #888; text-align: center; max-width: 500px; border: 1px solid #333; padding: 10px;">
                MANTÃ‰N EL RITMO PARA LLEVAR A LOS NPC AL CORRAL AZUL. <br>
                CONFIGURA LOS EFECTOS DE POWER-UPS ANTES DE EMPEZAR.
            </div>
            <div id="pre-game-pu-list"></div>
            <div style="display:flex; gap:10px;">
                <button id="btn-random-pu" class="btn" style="border-color:var(--powerup-color)">RANDOMIZE_PU</button>
                <button id="start-btn" class="btn" style="color:var(--accent-color); font-size: 16px; border-color: var(--accent-color); padding: 15px 40px;">INITIALIZE_SESSION</button>
            </div>
        </div>

        <div id="ui-layer">
            <div id="combo-counter">000</div>
            <div id="accuracy-feedback">SYSTEM_READY</div>
        </div>
        
        <div id="game-container">
            <canvas id="zona-juego" width="450" height="350"></canvas>
            <div id="zona-beat">
                <div id="beat-target"></div>
                <!-- DDR - LÃNEA DEL CARRIL -->
                <div style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: rgba(255,255,255,0.1); transform: translateY(-50%); z-index: 1;"></div>
            </div>
        </div>
        
        <div id="status-hud">
            <div id="status-label">EFFECT: NONE</div>
            <div class="progress-bar-container"><div id="progress-fill"></div></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        // --- DATA & CONSTANTS ---
        const EFFECTS_LIST = {
            invert_controls: "CONTROLES INVERTIDOS",
            pause_beat: "SKIP_BEAT (8/8)",
            double_tempo: "DOUBLE_STEP (X2)",
            shake_screen: "MAREO (TEMBLOR)",
            tilt_screen: "MAREO (TILT)",
            invert_colors: "EPILEPSIA (FLASH)",
            off_beat: "OFF-BEAT CHALLENGE"
        };

        const PU_TYPES = {
            'DRINK':  { char: 'ðŸ¹', def: 'invert_controls', color: '#ff4444', desc: "Invierte flechas." },
            'CIGS':   { char: 'ðŸš¬', def: 'pause_beat', color: '#aaaaaa', desc: "Beat 8 vacÃ­o." },
            'PILL':   { char: 'ðŸ’Š', def: 'double_tempo', color: '#00ffff', desc: "Salto doble." },
            'WEED':   { char: 'ðŸŒ¿', def: 'tilt_screen', color: '#00ff00', desc: "Pantalla torcida." },
            'SHADES': { char: 'ðŸ•¶ï¸', def: 'invert_colors', color: '#ffffff', desc: "Efecto flash." },
            'MUSH':   { char: 'ðŸ„', def: 'off_beat', color: '#ff00ff', desc: "Doble nota." },
            'WATER':  { char: 'ðŸ’§', def: 'shake_screen', color: '#3333ff', desc: "Terremoto visual." }
        };

        // --- STATE ---
        let canvas, ctx, kick, snare, kickVolume, snareVolume;
        let config = { grid: 20, bpm: 120, tolerance: 100, collision: true, npcCount: 25, followRadius: 9, kickType: 'deep', showHints: true, snareEnabled: true, noteSpeed: 900, noteWindow: 0.75 };
        let appearance = { 
            dj: true, barman: true, sofas: true, tables: true, screens: true, lasers: true, 
            sidebars: true, smoking: true, wc: true, avatar: '(âŒâ– _â– )', playerGlow: false,
            djTable: true, extraLasers: false, advancedLaser: false, ledLights: false, 
            lights: false, smokeMachine: true, speakers: false, barCounter: false
        };
        let currentStatus = { type: null, label: 'NONE', beats: 0, maxBeats: 0 };
        let player = { x: 5, y: 5 }, npcs = [], obstacles = [], activeNotes = [], activePowerUpsOnMap = [], puConfig = {};
        let blueZone = { x: 14, y: 13, w: 8, h: 8 };
        let combo = 0, isStarted = false, beatCounter = 0, canMove = false, djStep = 0;

        // --- INITIALIZATION ---
        window.onload = () => {
            canvas = document.getElementById('zona-juego');
            ctx = canvas.getContext('2d');
            Object.keys(PU_TYPES).forEach(id => {
                puConfig[id] = { effect: PU_TYPES[id].def, rate: 15, dur: 16, last: Date.now(), enabled: true };
            });
            renderPreGameMenu();
            initPowerUpMenu();
            generarLayout();
            reiniciarEscena();
            requestAnimationFrame(draw);
        };

        // --- AUDIO ENGINE ---
        function updateKickParams() {
            if (config.kickType === 'deep') kick.set({ pitchDecay: 0.08, octaves: 5 });
            else if (config.kickType === 'tight') kick.set({ pitchDecay: 0.02, octaves: 2 });
            else kick.set({ pitchDecay: 0.1, octaves: 10 });
        }

        const loop = new Tone.Loop((time) => {
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'loop:entry',message:'Loop triggered',data:{beatCounter,isStarted,canMove,activeNotesCount:activeNotes.length,combo,doubleTempo:currentStatus.type==='double_tempo'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B,E'})}).catch(()=>{});
            // #endregion
            const isPause = (currentStatus.type === 'pause_beat' && (beatCounter+1)%8 === 0);
            if (!isPause) {
                kick.triggerAttackRelease("C1", "8n", time);
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'loop:kick',message:'Kick triggered',data:{time:time*1000},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
                // #endregion
                if (currentStatus.type === 'off_beat') {
                    Tone.Draw.schedule(() => crearNota(true), time + Tone.Time("8n").toSeconds());
                }
            }
            if (config.snareEnabled) snare.triggerAttackRelease("16n", time + Tone.Time("8n").toSeconds());

            Tone.Draw.schedule(() => {
                beatCounter++;
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'loop:schedule',message:'Beat scheduled',data:{beatCounter,canMoveBefore:canMove},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                // #endregion
                updateHUD();
                if (isStarted) spawnPowerUps();
                if (beatCounter % 16 === 0 && document.getElementById('playlist-auto-bpm').checked) autoAdjustBpm();
                djStep = (djStep + 1) % 2;
                actualizarNPCs(true);
                // Only create normal note if NOT in double_tempo mode (double_tempo uses its own loop)
                if (currentStatus.type !== 'double_tempo') {
                    crearNota(false);
                }
                // PenalizaciÃ³n: Si hay demasiadas notas acumuladas, resetear combo
                if (activeNotes.length > 20) {
                    combo = 0;
                    document.getElementById('combo-counter').innerText = "000";
                    document.getElementById('accuracy-feedback').innerText = "OVERLOAD";
                    document.getElementById('accuracy-feedback').style.color = "var(--miss)";
                    // Eliminar todas las notas acumuladas
                    activeNotes.forEach(note => note.el.remove());
                    activeNotes = [];
                }
                canMove = true;
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'loop:after',message:'canMove set to true',data:{canMove,activeNotesCount:activeNotes.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                // #endregion
            }, time);
        }, "4n");

        // Double tempo loop: creates notes at 1/4 and 3/4 steps (on-beat and off-beat)
        // Runs at 8n intervals to create notes at both positions within each 4n period
        let doubleTempoNoteCounter = 0;
        const doubleTempoLoop = new Tone.Loop((time) => {
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'doubleTempoLoop:entry',message:'Double tempo loop triggered',data:{beatCounter,isStarted,activeNotesCount:activeNotes.length,noteCounter:doubleTempoNoteCounter},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B,E'})}).catch(()=>{});
            // #endregion
            if (!isStarted || currentStatus.type !== 'double_tempo') return;
            
            Tone.Draw.schedule(() => {
                // Alternate between 1/4 (on-beat) and 3/4 (off-beat) notes
                const isOffbeat = (doubleTempoNoteCounter % 2 === 1);
                crearNota(isOffbeat, true); // second param indicates double_tempo mode
                canMove = true;
                doubleTempoNoteCounter++;
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'doubleTempoLoop:noteCreated',message:'Double tempo note created',data:{isOffbeat,activeNotesCount:activeNotes.length,noteCounter:doubleTempoNoteCounter},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B,E'})}).catch(()=>{});
                // #endregion
            }, time);
        }, "8n");

        function autoAdjustBpm() {
            config.bpm = Math.min(Math.max(parseInt(config.bpm) + (Math.random() > 0.5 ? 5 : -5), 60), 220);
            Tone.Transport.bpm.rampTo(config.bpm, 1);
            document.getElementById('bpm-display').innerText = `BPM: ${Math.round(config.bpm)}`;
        }

        // --- CORE LOGIC ---
        function generarLayout() {
            obstacles = []; const g = config.grid;
            blueZone = { x: Math.floor(g*0.4), y: Math.floor(g*0.4), w: Math.floor(g*0.2)+2, h: Math.floor(g*0.2)+2 };
            
            if (appearance.dj) obstacles.push({x: Math.floor(g/2), y: 1, type: 'dj'});
            if (appearance.barman) obstacles.push({x: g-3, y: Math.floor(g/2), char: '(à² _à² )æ—¦', color: '#aaa'});
            if (appearance.sofas) {
                for(let i=2; i<6; i++) obstacles.push({x: i, y: g-3, char: 'TTT', color: '#01CDFE'});
            }
            if (appearance.tables) {
                obstacles.push({x: 3, y: g-5, char: 'â”¬â”€â”¬', color: '#01CDFE'});
            }
            if (appearance.screens) {
                obstacles.push({x: Math.floor(g*0.2), y: 0, char: '[REC]', color: '#500'});
                obstacles.push({x: Math.floor(g*0.8), y: 0, char: '[REC]', color: '#500'});
            }
            if (appearance.sidebars) {
                for(let y=Math.floor(g*0.3); y<Math.floor(g*0.7); y++) obstacles.push({x: 1, y: y, char: 'â–’', color: '#01CDFE'});
            }
            if (appearance.smoking) obstacles.push({x: g-4, y: g-3, char: '(SS)', color: '#01CDFE'});
            if (appearance.wc) obstacles.push({x: 1, y: g-2, char: '[WC]', color: '#fff'});
            
            // Nuevos elementos decorativos
            if (appearance.djTable) {
                obstacles.push({x: Math.floor(g/2)-1, y: 2, type: 'djTable', char: 'â”Œâ”€â”', color: '#00ffff'});
                obstacles.push({x: Math.floor(g/2), y: 2, type: 'djTable', char: 'â”‚â–Œâ”‚', color: '#00ffff'});
                obstacles.push({x: Math.floor(g/2)+1, y: 2, type: 'djTable', char: 'â””â”€â”˜', color: '#00ffff'});
            }
            if (appearance.barCounter) {
                for(let x = g-6; x < g-2; x++) {
                    obstacles.push({x: x, y: Math.floor(g/2)+1, type: 'barCounter', char: 'â•', color: '#ff00ff'});
                }
            }
            if (appearance.speakers) {
                obstacles.push({x: 0, y: Math.floor(g*0.25), type: 'speaker', char: 'â–ˆ', color: '#ffff00'});
                obstacles.push({x: 0, y: Math.floor(g*0.75), type: 'speaker', char: 'â–ˆ', color: '#ffff00'});
                obstacles.push({x: g-1, y: Math.floor(g*0.25), type: 'speaker', char: 'â–ˆ', color: '#ffff00'});
                obstacles.push({x: g-1, y: Math.floor(g*0.75), type: 'speaker', char: 'â–ˆ', color: '#ffff00'});
            }
        }

        function isOccupied(x, y) {
            if (x < 0 || x >= config.grid || y < 0 || y >= config.grid) return true;
            if (config.collision && obstacles.some(o => o.x === x && o.y === y)) return true;
            return false;
        }

        // Helper function to check if position is occupied by another NPC
        function isNPCOccupied(x, y, selfNpc) {
            if (typeof config.npcCollision === 'undefined' || !config.npcCollision) return false;
            return npcs.some(n => n !== selfNpc && n.x === x && n.y === y);
        }

        // Helper function to check if position is valid for NPC movement (obstacles + other NPCs)
        function isNPCBlocked(x, y, selfNpc) {
            if (isOccupied(x, y)) return true; // Check obstacles and bounds
            if (isNPCOccupied(x, y, selfNpc)) return true; // Check other NPCs
            return false;
        }

// === CORRAL HELPER: CHECK IF TILE IS INSIDE BLUE ZONE ===
        function isInsideBlueZone(x, y) {
            return (
                x >= blueZone.x &&
                x < blueZone.x + blueZone.w &&
                y >= blueZone.y &&
                y < blueZone.y + blueZone.h
            );
        }


        function reiniciarEscena() {
            player = { x: 2, y: 2 }; npcs = [];
            for(let i=0; i<config.npcCount; i++) {
                let x, y, attempts = 0;
                do { 
                    x = Math.floor(Math.random()*config.grid); 
                    y = Math.floor(Math.random()*config.grid); 
                    attempts++;
                } while((isOccupied(x, y) || isNPCOccupied(x, y, null)) && attempts < 100);
                if (attempts < 100) {
                    npcs.push({ x, y, color: 'red', char: '(à² _à² )', dir: 1 });
                }
            }
            activePowerUpsOnMap = [];
        }

        function spawnPowerUps() {
            const now = Date.now();
            Object.keys(puConfig).forEach(id => {
                if (puConfig[id].enabled && (now - puConfig[id].last > puConfig[id].rate * 1000)) {
                    let x, y; do { x=Math.floor(Math.random()*config.grid); y=Math.floor(Math.random()*config.grid); } while(isOccupied(x,y));
                    activePowerUpsOnMap.push({ x, y, id });
                    puConfig[id].last = now;
                }
            });
        }

        function actualizarNPCs(onKick) {
    // #region agent log
    fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'actualizarNPCs:entry',message:'Updating NPCs',data:{onKick,combo,npcCount:npcs.length,npcCollision:config.npcCollision},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
    // #endregion
    npcs.forEach(n => {
        const inZone = isInsideBlueZone(n.x, n.y);
        
        if(inZone) {
            n.color = '#0ff'; n.char = '(*^Ï‰^*)';
            if (onKick && Math.random() > 0.6) {
                const d = [[1,0],[-1,0],[0,1],[0,-1]][Math.floor(Math.random()*4)];
                const nx = n.x + d[0], ny = n.y + d[1];
                if (!isNPCBlocked(nx, ny, n) && isInsideBlueZone(nx, ny)) {
                    n.x = nx; n.y = ny; n.dir = d[0] || n.dir;
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'actualizarNPCs:moveInZone',message:'NPC moved in zone',data:{npcX:n.x,npcY:n.y},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                    // #endregion
                } else {
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'actualizarNPCs:blockedInZone',message:'NPC blocked in zone',data:{nx,ny,obstacle:isOccupied(nx,ny),npc:isNPCOccupied(nx,ny,n)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                    // #endregion
                }
            }
        } else if(onKick && combo > 0) { // <--- SOLO SIGUEN SI HAY COMBO
            const dist = Math.sqrt(Math.pow(n.x-player.x,2)+Math.pow(n.y-player.y,2));
            if (dist < config.followRadius) {
                n.color='#ffa500'; n.char='(â€¢_â€¢)>';
                let dx = n.x < player.x ? 1 : (n.x > player.x ? -1 : 0);
                let dy = n.y < player.y ? 1 : (n.y > player.y ? -1 : 0);
                if(!isNPCBlocked(n.x+dx, n.y+dy, n)) { 
                    n.x+=dx; n.y+=dy; n.dir=dx||n.dir; 
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'actualizarNPCs:moveFollow',message:'NPC moved following',data:{npcX:n.x,npcY:n.y},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                    // #endregion
                } else {
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'actualizarNPCs:blockedFollow',message:'NPC blocked following',data:{nx:n.x+dx,ny:n.y+dy,obstacle:isOccupied(n.x+dx,n.y+dy),npc:isNPCOccupied(n.x+dx,n.y+dy,n)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                    // #endregion
                }
            } else {
                n.color='red'; n.char='(à² _à² )';
            }
        } else { 
            // SI NO HAY COMBO O ESTÃN LEJOS
            n.color='red'; n.char='(à² _à² )'; 
        }
    });
}

        // ============================================
        // DDR - FUNCIÃ“N CREARNOTA MODIFICADA
        // ============================================
        function crearNota(isOffbeat, isDoubleTempo = false) {
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'crearNota:entry',message:'Creating note',data:{isOffbeat,isDoubleTempo,isStarted,activeNotesCount:activeNotes.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{});
            // #endregion
            if(!isStarted) return;
            
            const el = document.createElement('div'); 
            el.className = 'note';
            
            // DDR CONFIGURACIÃ“N - CARRIL ÃšNICO
            const laneHeight = 50; // Todas las notas en el centro (50%)
            el.style.top = `${laneHeight}%`;
            
            // DDR - SÃMBOLOS MUSICALES Y EMOJIS
            if (isDoubleTempo) {
                el.style.border = "3px solid var(--excellent)";
                el.style.background = "rgba(0, 255, 255, 0.5)";
                el.textContent = 'âš¡';
                el.style.boxShadow = "0 0 10px rgba(0, 255, 255, 0.5)";
            } else if (isOffbeat) {
                el.style.border = "2px solid var(--excellent)";
                el.style.background = "rgba(33, 150, 243, 0.5)";
                el.textContent = 'â€¢';
                el.style.borderRadius = "50%";
                el.style.boxShadow = "0 0 8px rgba(33, 150, 243, 0.5)";
            } else {
                el.style.border = "2px solid #ffffff";
                el.style.background = "rgba(255, 82, 82, 0.6)";
                const symbols = ['â™ª', 'â™«', 'â™¬', 'â™©'];
                el.textContent = symbols[beatCounter % symbols.length];
                el.style.boxShadow = "0 0 8px rgba(255, 82, 82, 0.5)";
            }
            
            // DDR - EMOJIS PARA POWER-UPS ACTIVOS
            if (currentStatus?.type) {
                const powerupEmojis = {
                    'double_tempo': ['âš¡', 'ðŸš€', 'ðŸ’¨'],
                    'invert_controls': ['ðŸ”„', 'â†ªï¸', 'â†©ï¸'],
                    'pause_beat': ['â¸ï¸', 'â±ï¸', 'â³'],
                    'shake_screen': ['ðŸŒªï¸', 'ðŸŒ€', 'ðŸ’«'],
                    'tilt_screen': ['ðŸ“', 'ðŸ“', 'âš–ï¸'],
                    'invert_colors': ['ðŸŒˆ', 'ðŸŽ¨', 'ðŸ–¼ï¸'],
                    'off_beat': ['ðŸŽµ', 'ðŸŽ¶', 'ðŸŽ¼']
                };
                if (powerupEmojis[currentStatus.type]) {
                    const emojis = powerupEmojis[currentStatus.type];
                    el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                }
            }
            
            // TamaÃ±o fijo para todas las notas DDR
            el.style.width = "30px";
            el.style.height = "30px";
            el.style.fontSize = "16px";
            el.style.fontWeight = "bold";
            el.style.display = "flex";
            el.style.alignItems = "center";
            el.style.justifyContent = "center";
            el.style.zIndex = "5";
            
            document.getElementById('zona-beat').appendChild(el);
            
            const obj = { el, isOffbeat, isDoubleTempo }; 
            activeNotes.push(obj);
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'crearNota:afterPush',message:'Note added to array',data:{activeNotesCount:activeNotes.length,objId:obj.el.id||'no-id',isDoubleTempo},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
            // #endregion

            // DDR - VELOCIDAD MUY LENTA Y ESPACIADO ORDENADO
            const noteDuration = 2800; // 2.8 segundos (muy lento)
            const noteWindow = config.noteWindow || 0.75;
            
            // DDR - POSICIÃ“N INICIAL ORDENADA (CARRIL LINEAL)
            const basePosition = 450;
            const spacing = 35; // PÃ­xeles entre notas (notas juntas)
            const noteOffset = activeNotes.length * spacing;
            const startPosition = Math.min(basePosition + noteOffset, 650); // MÃ¡ximo 650px
            
            el.style.left = `${startPosition}px`;
            
            const anim = el.animate([
                { left: `${startPosition}px`, opacity: 1 },
                { left: '30px', offset: noteWindow, opacity: 1 },
                { left: '-50px', opacity: 0 }
            ], {
                duration: noteDuration,
                easing: 'linear'
            });

            anim.onfinish = () => {
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'crearNota:onfinish',message:'Note animation finished',data:{activeNotesCount:activeNotes.length,stillInArray:activeNotes.includes(obj),comboBefore:combo,isDoubleTempo},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C,D'})}).catch(()=>{});
                // #endregion
                // Si la nota llega al final y sigue en el array, el jugador no la pulsÃ³: ES UN MISS
                if(activeNotes.includes(obj)) { 
                    combo = 0; 
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'crearNota:miss',message:'MISS detected - combo reset',data:{combo,activeNotesCountBefore:activeNotes.length,isDoubleTempo},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
                    // #endregion
                    document.getElementById('combo-counter').innerText = "000";
                    document.getElementById('accuracy-feedback').innerText = "MISS";
                    document.getElementById('accuracy-feedback').style.color = "var(--miss)";
                    activeNotes.shift(); 
                }
                el.remove();
            };
        }

        // ============================================
        // DDR - GENERAR TREN INICIAL DE 8 NOTAS
        // ============================================
        function generarTrenInicialDDR() {
            if (!isStarted) return;
            
            console.log('[DDR] Generando tren inicial de 8 notas...');
            
            // Calcular espaciado basado en BPM actual
            const bpm = config?.bpm || 120;
            const msPerBeat = 60000 / bpm;
            
            // Generar 8 notas escalonadas (para ver los prÃ³ximos 8 movimientos)
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    if (isStarted) {
                        // PatrÃ³n: on-beat, on-beat, off-beat
                        const isOffbeat = (i % 3 === 2); // Cada 3 notas, la tercera es off-beat
                        crearNota(isOffbeat, false);
                    }
                }, i * (msPerBeat / 1.5)); // Notas mÃ¡s juntas para densidad
            }
        }
        
        function updateHUD() {
            if (currentStatus.beats > 0) {
                currentStatus.beats--;
                document.getElementById('status-hud').style.display = 'flex';
                document.getElementById('status-label').innerText = `EFECTO: ${currentStatus.label}`;
                document.getElementById('progress-fill').style.width = (currentStatus.beats / currentStatus.maxBeats * 100) + "%";
                if (currentStatus.type === 'invert_colors' && beatCounter % 2 === 0) document.getElementById('game-container').classList.toggle('inverted');
                if (currentStatus.type === 'shake_screen') {
                    const i = 10; document.getElementById('game-container').style.transform = `translate(${(Math.random()-0.5)*i}px, ${(Math.random()-0.5)*i}px)`;
                }
                if (currentStatus.type === 'tilt_screen') { document.getElementById('game-container').style.transform = `rotate(${Math.sin(beatCounter)*5}deg)`; }
                
                // Manage double_tempo loop
                if (currentStatus.type === 'double_tempo' && !doubleTempoLoop.state) {
                    doubleTempoLoop.start(0);
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'updateHUD:startDoubleTempo',message:'Double tempo loop started',data:{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B,E'})}).catch(()=>{});
                    // #endregion
                }
            } else {
                // Stop double_tempo loop when effect ends
                if (currentStatus.type === 'double_tempo' && doubleTempoLoop.state) {
                    doubleTempoLoop.stop();
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'updateHUD:stopDoubleTempo',message:'Double tempo loop stopped',data:{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B,E'})}).catch(()=>{});
                    // #endregion
                }
                currentStatus.type = null; document.getElementById('status-hud').style.display = 'none';
                document.getElementById('game-container').classList.remove('inverted');
                document.getElementById('game-container').style.transform = 'none';
            }
            document.getElementById('combo-counter').innerText = combo.toString().padStart(3, '0');
        }

        // --- RENDER ---
        function draw() {
            const g = config.grid;
            const cw = 450/g, ch = 350/g;
            ctx.clearRect(0,0,450,350);
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,450,350);

            // Grid y Corral
            ctx.fillStyle = "rgba(0, 150, 255, 0.4)";
            ctx.fillRect(blueZone.x*cw, blueZone.y*ch, blueZone.w*cw, blueZone.h*ch);

            // Lasers (V5) - Original
            if (appearance.lasers && isStarted && djStep === 0) {
                ctx.strokeStyle = `hsl(${Math.random()*360}, 100%, 50%)`;
                ctx.beginPath(); ctx.moveTo(225, 0); ctx.lineTo(Math.random()*450, 350); ctx.stroke();
            }
            
            // Extra Lasers (4x) - Solo si estÃ¡ habilitado
            if (appearance.extraLasers && isStarted) {
                const laserColors = ['#ff00ff', '#00ffff', '#ffff00', '#ff00ff'];
                const laserPositions = [
                    {x1: 100, y1: 0, x2: 50, y2: 350},
                    {x1: 350, y1: 0, x2: 400, y2: 350},
                    {x1: 0, y1: 100, x2: 450, y2: 150},
                    {x1: 0, y1: 250, x2: 450, y2: 200}
                ];
                laserPositions.forEach((pos, i) => {
                    if (beatCounter % 4 === i) {
                        ctx.strokeStyle = laserColors[i];
                        ctx.lineWidth = 2;
                        ctx.shadowBlur = 10;
                        ctx.shadowColor = laserColors[i];
                        ctx.beginPath();
                        ctx.moveTo(pos.x1, pos.y1);
                        ctx.lineTo(pos.x2, pos.y2);
                        ctx.stroke();
                        ctx.shadowBlur = 0;
                    }
                });
            }
            
            // Advanced Laser (dibujando) - Solo si estÃ¡ habilitado
            if (appearance.advancedLaser && isStarted) {
                const laserTime = beatCounter * 0.1;
                ctx.strokeStyle = `hsl(${(laserTime * 30) % 360}, 100%, 60%)`;
                ctx.lineWidth = 3;
                ctx.shadowBlur = 15;
                ctx.shadowColor = `hsl(${(laserTime * 30) % 360}, 100%, 60%)`;
                ctx.beginPath();
                const points = 20;
                for(let i = 0; i <= points; i++) {
                    const t = i / points;
                    const x = 50 + (400 * t) + Math.sin(laserTime + t * Math.PI * 2) * 30;
                    const y = 50 + (250 * t) + Math.cos(laserTime + t * Math.PI * 2) * 30;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
                ctx.shadowBlur = 0;
            }
            
            // LED Ambient Lights - Solo si estÃ¡ habilitado
            if (appearance.ledLights && isStarted) {
                const ledCount = 12;
                for(let i = 0; i < ledCount; i++) {
                    const angle = (i / ledCount) * Math.PI * 2 + (beatCounter * 0.1);
                    const radius = 180;
                    const x = 225 + Math.cos(angle) * radius;
                    const y = 175 + Math.sin(angle) * radius;
                    const hue = (i * 30 + beatCounter * 5) % 360;
                    ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                    ctx.shadowBlur = 8;
                    ctx.shadowColor = `hsl(${hue}, 100%, 50%)`;
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.shadowBlur = 0;
            }
            
            // Lights (luces de escenario) - Solo si estÃ¡ habilitado
            if (appearance.lights && isStarted) {
                const lightPositions = [
                    {x: 100, y: 20, color: '#ff00ff'},
                    {x: 350, y: 20, color: '#00ffff'},
                    {x: 225, y: 330, color: '#ffff00'}
                ];
                lightPositions.forEach((light, i) => {
                    if (beatCounter % 3 === i) {
                        const intensity = 0.3 + Math.sin(beatCounter * 0.5) * 0.2;
                        ctx.fillStyle = light.color;
                        ctx.globalAlpha = intensity;
                        ctx.shadowBlur = 20;
                        ctx.shadowColor = light.color;
                        ctx.beginPath();
                        ctx.arc(light.x, light.y, 25, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.globalAlpha = 1;
                        ctx.shadowBlur = 0;
                    }
                });
            }
            
            // Smoke Machine - Solo si estÃ¡ habilitado
            if (appearance.smokeMachine && isStarted) {
                const smokeX = (g-4) * cw;
                const smokeY = (g-3) * ch;
                const smokeIntensity = Math.sin(beatCounter * 0.3) * 0.5 + 0.5;
                ctx.fillStyle = `rgba(200, 200, 200, ${smokeIntensity * 0.4})`;
                ctx.beginPath();
                ctx.arc(smokeX, smokeY, 15 + Math.sin(beatCounter * 0.5) * 5, 0, Math.PI * 2);
                ctx.fill();
                // PartÃ­culas de humo
                for(let i = 0; i < 5; i++) {
                    const offsetX = (Math.sin(beatCounter * 0.2 + i) * 20);
                    const offsetY = -20 - (beatCounter % 8) * 3;
                    ctx.fillStyle = `rgba(255, 255, 255, ${0.3 - i * 0.05})`;
                    ctx.beginPath();
                    ctx.arc(smokeX + offsetX, smokeY + offsetY, 3 + i, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // Speakers con movimiento - Solo si estÃ¡ habilitado
            if (appearance.speakers && isStarted) {
                const speakerObstacles = obstacles.filter(o => o.type === 'speaker');
                const bassIntensity = Math.abs(Math.sin(beatCounter * 0.5));
                speakerObstacles.forEach(speaker => {
                    const scale = 1 + bassIntensity * 0.2;
                    ctx.save();
                    ctx.translate((speaker.x + 0.5) * cw, (speaker.y + 1) * ch);
                    ctx.scale(scale, 1);
                    ctx.fillStyle = speaker.color;
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = speaker.color;
                    ctx.font = `${ch}px Courier`;
                    ctx.textAlign = "center";
                    ctx.fillText(speaker.char, 0, 0);
                    ctx.restore();
                });
            }

            // Power-Ups
            activePowerUpsOnMap.forEach(p => {
                const color = PU_TYPES[p.id].color;
                ctx.strokeStyle = color; ctx.strokeRect(p.x*cw+1, p.y*ch+1, cw-2, ch-2);
                ctx.fillStyle = color; ctx.font = `${ch*0.8}px Courier`; ctx.textAlign="center";
                ctx.fillText(PU_TYPES[p.id].char, (p.x+0.5)*cw, (p.y+0.8)*ch);
            });

            // DecoraciÃ³n
            ctx.font = `${ch}px Courier`; ctx.textAlign="center";
            obstacles.forEach(o => {
                if(o.type === 'dj') { 
                    ctx.fillStyle="#fff"; 
                    ctx.fillText(djStep ? "(âŒâ– _â– )ãƒŽ" : "(âŒâ– _â– )â”›", (o.x+0.5)*cw, (o.y+1)*ch); 
                } else if(o.type === 'djTable') {
                    // Mesa de DJ con controles neÃ³n
                    ctx.fillStyle = o.color;
                    ctx.shadowBlur = 5;
                    ctx.shadowColor = o.color;
                    ctx.fillText(o.char, (o.x+0.5)*cw, (o.y+1)*ch);
                    // Controles parpadeantes
                    if (beatCounter % 2 === 0) {
                        ctx.fillStyle = '#ff00ff';
                        ctx.fillText('â—', (o.x+0.5)*cw, (o.y+0.5)*ch);
                    }
                    ctx.shadowBlur = 0;
                } else if(o.type === 'barCounter') {
                    // Barra del barman con efecto neÃ³n
                    ctx.fillStyle = o.color;
                    ctx.shadowBlur = 8;
                    ctx.shadowColor = o.color;
                    ctx.fillText(o.char, (o.x+0.5)*cw, (o.y+1)*ch);
                    ctx.shadowBlur = 0;
                } else if(o.type === 'speaker') {
                    // Los speakers se dibujan arriba con animaciÃ³n
                    // No dibujar aquÃ­, se dibujan en la secciÃ³n de speakers
                } else { 
                    ctx.fillStyle=o.color; 
                    ctx.fillText(o.char, (o.x+0.5)*cw, (o.y+1)*ch); 
                }
            });

            // NPCs
            npcs.forEach(n => { 
                ctx.fillStyle=n.color; ctx.save(); ctx.translate((n.x+0.5)*cw, (n.y+1)*ch); ctx.scale(n.dir, 1);
                ctx.fillText(n.char, 0, 0); ctx.restore();
            });

            // Player
            if(appearance.playerGlow) { ctx.fillStyle="rgba(0,255,0,0.15)"; ctx.fillRect(player.x*cw, player.y*ch, cw, ch); }
            ctx.fillStyle="#0f0"; ctx.fillText(appearance.avatar, (player.x+0.5)*cw, (player.y+1)*ch);

            requestAnimationFrame(draw);
        }

        // --- INPUT ---
        window.addEventListener('keydown', (e) => {
    // #region agent log
    fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'keydown:entry',message:'Key pressed',data:{key:e.key,isStarted,canMove,activeNotesCount:activeNotes.length,combo},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
    // #endregion
    // Si no hay notas activas, no puede haber acierto (LÃ³gica de Steps)
    if(!isStarted || !canMove || activeNotes.length === 0) {
        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'keydown:blocked',message:'Key blocked',data:{isStarted,canMove,activeNotesCount:activeNotes.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
        // #endregion
        return;
    }
    
    const n = activeNotes[0];
    
    // Verificar timing: la nota debe estar cerca del target (ventana de timing mÃ¡s estricta)
    const noteRect = n.el.getBoundingClientRect();
    const targetRect = document.getElementById('beat-target').getBoundingClientRect();
    const noteLeft = noteRect.left;
    const targetLeft = targetRect.left;
    const distance = Math.abs(noteLeft - targetLeft);
    const maxDistance = 60; // Distancia mÃ¡xima permitida (mÃ¡s estricto que antes)
    
    // Si la nota estÃ¡ demasiado lejos del target, es un error de timing
    if (distance > maxDistance) {
        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'keydown:timingError',message:'Timing error - too early/late',data:{distance,maxDistance,combo},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
        // #endregion
        combo = 0;
        document.getElementById('combo-counter').innerText = "000";
        document.getElementById('accuracy-feedback').innerText = "TIMING_ERROR";
        document.getElementById('accuracy-feedback').style.color = "var(--miss)";
        n.el.remove();
        activeNotes.shift();
        canMove = false;
        return;
    }
    let k = e.key;

    // LÃ³gica de Power-Ups de tu cÃ³digo original
    if(currentStatus.type === 'invert_controls') {
        const inv = { ArrowUp:'ArrowDown', ArrowDown:'ArrowUp', ArrowLeft:'ArrowRight', ArrowRight:'ArrowLeft' };
        k = inv[k] || k;
    }

    let nX = player.x, nY = player.y;
    // Double tempo no longer affects step size - it affects note timing instead
    let step = 1;
    if(k==='ArrowUp') nY-=step; 
    if(k==='ArrowDown') nY+=step; 
    if(k==='ArrowLeft') nX-=step; 
    if(k==='ArrowRight') nX+=step;

    if(!isOccupied(nX, nY)) { 
        player.x = nX; 
        player.y = nY; 
        
        // INCREMENTO DE COMBO Y ACTUALIZACIÃ“N VISUAL
        const comboBefore = combo;
        combo++;
        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'keydown:comboInc',message:'Combo incremented',data:{comboBefore,comboAfter:combo,activeNotesCountBefore:activeNotes.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
        // #endregion
        document.getElementById('combo-counter').innerText = combo.toString().padStart(3, '0');
        
        // DDR - FEEDBACK VISUAL AL GOLPEAR NOTA
        if (activeNotes[0] && activeNotes[0].el) {
            const noteEl = activeNotes[0].el;
            noteEl.classList.add('hit');
            noteEl.style.background = 'rgba(0, 255, 0, 0.7)';
            noteEl.style.boxShadow = '0 0 15px rgba(0, 255, 0, 0.5)';
            
            setTimeout(() => {
                if (noteEl) {
                    noteEl.classList.remove('hit');
                }
            }, 150);
        }
        
        // Feedback de precisiÃ³n basado en quÃ© tan cerca estÃ¡ la nota del target
        const timingAccuracy = 1 - (distance / maxDistance);
        if (timingAccuracy > 0.9) {
            document.getElementById('accuracy-feedback').innerText = "PERFECT!";
            document.getElementById('accuracy-feedback').style.color = "var(--excellent)";
        } else if (timingAccuracy > 0.7) {
            document.getElementById('accuracy-feedback').innerText = "GREAT!";
            document.getElementById('accuracy-feedback').style.color = "var(--great)";
        } else {
            document.getElementById('accuracy-feedback').innerText = "GOOD";
            document.getElementById('accuracy-feedback').style.color = "var(--good)";
        }
        
        // Eliminar nota y bloquear hasta siguiente beat
        n.el.remove(); 
        activeNotes.shift(); 
        canMove = false; 
        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'keydown:afterMove',message:'After move',data:{canMove,activeNotesCount:activeNotes.length,combo},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
        // #endregion

        // DetecciÃ³n de Power-Ups en el mapa (original de tu V9)
        const pIdx = activePowerUpsOnMap.findIndex(p => p.x === player.x && p.y === player.y);
        if(pIdx !== -1) {
            const pu = activePowerUpsOnMap[pIdx];
            // Stop previous double_tempo loop if switching to a different effect
            if (currentStatus.type === 'double_tempo' && typeof doubleTempoLoop !== 'undefined' && doubleTempoLoop.state) {
                doubleTempoLoop.stop();
            }
            currentStatus = { type: puConfig[pu.id].effect, label: EFFECTS_LIST[puConfig[pu.id].effect], beats: puConfig[pu.id].dur, maxBeats: puConfig[pu.id].dur };
            // Start double_tempo loop immediately if this is the double_tempo power-up
            if (currentStatus.type === 'double_tempo' && isStarted && typeof doubleTempoLoop !== 'undefined') {
                doubleTempoLoop.start(0);
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'keydown:startDoubleTempo',message:'Double tempo activated via power-up',data:{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B,E'})}).catch(()=>{});
                // #endregion
            }
            activePowerUpsOnMap.splice(pIdx, 1);
        }
    } else {
        // Si choca con un obstÃ¡culo, se rompe el combo
        combo = 0;
        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/8e398c92-5a00-4d2e-8c26-bde5f94162b8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'keydown:collision',message:'Collision detected',data:{combo},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
        // #endregion
        document.getElementById('combo-counter').innerText = "000";
        document.getElementById('accuracy-feedback').innerText = "COLLISION";
        document.getElementById('accuracy-feedback').style.color = "var(--miss)";
    }
});
        // --- UI MENUS ---
        function renderPreGameMenu() {
            const container = document.getElementById('pre-game-pu-list'); container.innerHTML = "";
            Object.keys(PU_TYPES).forEach(id => {
                const div = document.createElement('div');
                div.innerHTML = `<label style="color:${PU_TYPES[id].color}"><input type="checkbox" id="pre-${id}" ${puConfig[id].enabled?'checked':''}> ${PU_TYPES[id].char} ${id}</label>`;
                container.appendChild(div);
                document.getElementById(`pre-${id}`).onchange = (e) => puConfig[id].enabled = e.target.checked;
            });
        }

        function initPowerUpMenu() {
            const container = document.getElementById('pu-controls-container'); container.innerHTML = "";
            Object.keys(PU_TYPES).forEach(id => {
                const div = document.createElement('div'); div.className = 'debug-group';
                div.innerHTML = `
                    <label style="color:${PU_TYPES[id].color}">${id} <input type="checkbox" ${puConfig[id].enabled?'checked':''} onchange="puConfig['${id}'].enabled=this.checked"></label>
                    <select onchange="puConfig['${id}'].effect=this.value">
                        ${Object.keys(EFFECTS_LIST).map(eff => `<option value="${eff}" ${puConfig[id].effect===eff?'selected':''}>${EFFECTS_LIST[eff]}</option>`).join('')}
                    </select>
                `;
                container.appendChild(div);
            });
        }

        // --- BINDINGS ---
        document.getElementById('start-btn').onclick = async () => {
    await Tone.start();

    // LEER VALORES DIRECTOS DE LOS SLIDERS
    const initialKickVol = parseFloat(document.getElementById('input-kick-volume').value);
    const initialSnareVol = parseFloat(document.getElementById('input-snare-volume').value);

    // Inicializar nodos con los valores reales del slider
    kickVolume = new Tone.Volume(initialKickVol).toDestination();
    snareVolume = new Tone.Volume(initialSnareVol).toDestination();
    
    kick = new Tone.MembraneSynth().connect(kickVolume);
    snare = new Tone.NoiseSynth({ envelope: { decay: 0.1 } }).connect(snareVolume);
    
    updateKickParams();
    Tone.Transport.bpm.value = config.bpm;
    Tone.Transport.start(); 
    loop.start(0);
    isStarted = true; 
    document.getElementById('start-overlay').style.display = 'none';
    
    // DDR - GENERAR TREN INICIAL DE 8 NOTAS
    setTimeout(generarTrenInicialDDR, 300);
};

        const bind = (id, target, prop, callback) => {
            const el = document.getElementById(id);
            if(el.type === 'checkbox') el.onchange = (e) => { target[prop] = e.target.checked; if(callback) callback(); };
            else el.oninput = (e) => { target[prop] = e.target.value; if(callback) callback(); };
        };

        bind('input-grid', config, 'grid', () => { generarLayout(); reiniciarEscena(); });
        bind('input-npc', config, 'npcCount', reiniciarEscena);
        bind('input-bpm', config, 'bpm', () => Tone.Transport.bpm.value = config.bpm);
        bind('input-follow', config, 'followRadius');
        bind('input-tol', config, 'tolerance');
        bind('input-note-speed', config, 'noteSpeed', () => {
            // Actualizar velocidad de notas existentes no es posible, pero nuevas notas usarÃ¡n el nuevo valor
        });
        bind('input-note-window', config, 'noteWindow', () => {
            // Actualizar ventana de timing para nuevas notas
        });
        bind('input-kick-type', config, 'kickType', updateKickParams);
        bind('input-snare-type', config, 'snareType', () => snare.noise.type = config.snareType);
        bind('check-snare-master', config, 'snareEnabled');
        
        // Toggles DecoraciÃ³n
        const deco = ['dj', 'barman', 'sofas', 'tables', 'screens', 'lasers', 'sidebars', 'smoking', 'wc'];
        deco.forEach(id => bind(`check-${id}`, appearance, id, generarLayout));
        
        // Nuevos toggles decorativos
        bind('check-dj-table', appearance, 'djTable', generarLayout);
        bind('check-extra-lasers', appearance, 'extraLasers');
        bind('check-advanced-laser', appearance, 'advancedLaser');
        bind('check-led-lights', appearance, 'ledLights');
        bind('check-lights', appearance, 'lights');
        bind('check-smoke-machine', appearance, 'smokeMachine');
        bind('check-speakers', appearance, 'speakers', generarLayout);
        bind('check-bar-counter', appearance, 'barCounter', generarLayout);

        document.getElementById('user-avatar').onchange = (e) => appearance.avatar = e.target.value;
        document.getElementById('input-volume').oninput = (e) => Tone.Destination.volume.value = e.target.value;
        
        // Controles de volumen individuales para kick y snare
        document.getElementById('input-kick-volume').oninput = (e) => {
            if (kickVolume) kickVolume.volume.value = e.target.value;
        };
        document.getElementById('input-snare-volume').oninput = (e) => {
            if (snareVolume) snareVolume.volume.value = e.target.value;
        };

        const setupPanel = (btn, panel) => {
            document.getElementById(btn).onclick = () => document.getElementById(panel).style.display = 'flex';
            document.getElementById('close-'+panel.split('-')[0]).onclick = () => document.getElementById(panel).style.display = 'none';
        };
        setupPanel('open-appearance', 'appearance-panel');
        setupPanel('open-playlist', 'playlist-panel');
        setupPanel('open-powerups', 'powerup-panel');
        setupPanel('open-debug', 'debug-panel');

        document.getElementById('btn-random-pu').onclick = () => {
            Object.keys(puConfig).forEach(k => puConfig[k].enabled = Math.random() > 0.4);
            renderPreGameMenu();
        };
    </script>
</body>
</html>
